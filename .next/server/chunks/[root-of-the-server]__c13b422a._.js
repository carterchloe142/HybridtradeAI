module.exports=[59639,(e,t,r)=>{t.exports=e.x("node:process",()=>require("node:process"))},50227,(e,t,r)=>{t.exports=e.x("node:path",()=>require("node:path"))},57764,(e,t,r)=>{t.exports=e.x("node:url",()=>require("node:url"))},4733,e=>e.a(async(t,r)=>{try{let t=await e.y("@prisma/client/runtime/library");e.n(t),r()}catch(e){r(e)}},!0),94131,(e,t,r)=>{t.exports=e.x("@supabase/supabase-js",()=>require("@supabase/supabase-js"))},30772,e=>{"use strict";let t;var r=e.i(94131);let a=process.env.SUPABASE_URL||"https://wdlcttgfwoejqynlylpv.supabase.co",s=process.env.SUPABASE_SERVICE_ROLE_KEY||"",i=!!(a&&s),n=i?(0,r.createClient)(a,s):{auth:{getUser:t=async()=>{throw Error("supabase_service_not_configured")}},from:()=>({select:t,insert:t,update:t,delete:t,eq:()=>({select:t,insert:t,update:t,delete:t}),order:()=>({select:t}),range:()=>({select:t}),maybeSingle:t})};e.s(["supabaseServer",0,n,"supabaseServiceReady",0,i])},56798,e=>{"use strict";var t=e.i(30772);async function r(e){try{let r=String(e.headers.authorization||""),a=r.startsWith("Bearer ")?r.slice(7):"";if(!a)return{ok:!1,error:"Missing Authorization bearer token"};let{data:s,error:i}=await t.supabaseServer.auth.getUser(a);if(i||!s?.user?.id)return{ok:!1,error:"Invalid token"};let n=s.user.id,{data:o,error:d}=await t.supabaseServer.from("profiles").select("role,is_admin").eq("user_id",n).maybeSingle();if(d)return{ok:!1,error:"Profile lookup failed"};let l=String(o?.role||"").toLowerCase();if(!(o?.is_admin||"admin"===l))return{ok:!1,error:"Forbidden"};return{ok:!0,userId:n}}catch(e){return{ok:!1,error:e?.message||"Admin check failed"}}}e.s(["requireAdmin",()=>r])},55750,e=>{"use strict";let t=new Map;function r(e){return async function(r,a,s){let i=(r.headers["x-forwarded-for"]||"").split(",")[0].trim()||r.socket?.remoteAddress||"unknown",n=`${i}:${s}`,o=Date.now(),d=t.get(n);if(!d||o>d.resetAt)return t.set(n,{count:1,resetAt:o+e.windowMs}),a.setHeader("X-RateLimit-Remaining",String(e.max-1)),!0;if(d.count>=e.max){let e=d.resetAt-o;return a.setHeader("Retry-After",String(Math.ceil(e/1e3))),a.status(429).json({error:"Too many requests"}),!1}return d.count+=1,t.set(n,d),a.setHeader("X-RateLimit-Remaining",String(e.max-d.count)),!0}}e.s(["createRateLimiter",()=>r])},26858,e=>e.a(async(t,r)=>{try{var a=e.i(55750),s=e.i(56798),i=e.i(30772),n=e.i(82911),o=t([n]);[n]=o.then?(await o)():o;let l=(0,a.createRateLimiter)({windowMs:6e4,max:20});async function d(t,r){let a=await (0,s.requireAdmin)(t);if(!a.ok)return r.status(401).json({error:a.error||"unauthorized"});if("GET"===t.method){let e=String(t.query?.userId||"");if("1"===String(t.query?.files||"")&&e)try{let t=i.supabaseServer.storage.from("kyc"),a=await t.list(e,{limit:20}),s=Array.isArray(a.data)?a.data:[],n=e=>s.find(t=>String(t.name).startsWith(e)),d=n("id"),l=n("selfie_neutral"),u=n("selfie_smile"),c=n("selfie_left"),p=n("selfie_right"),f=s.find(e=>"data.json"===String(e.name));async function o(r){if(!r)return;let a=await t.createSignedUrl(`${e}/${r}`,3600);return a.data?.signedUrl}let m=d?await o(d.name):void 0,y=await o(l?.name),g=await o(u?.name),w=await o(c?.name),h=await o(p?.name),v=null;if(f){let{data:r}=await t.download(`${e}/data.json`);if(r){let e=await r.text();try{v=JSON.parse(e)}catch{v={raw:e}}}}return r.json({ok:!0,files:{idUrl:m,neutralUrl:y,smileUrl:g,leftUrl:w,rightUrl:h},details:v})}catch(e){return r.status(500).json({error:e?.message||"files_failed"})}let a=await i.supabaseServer.from("profiles").select("*");if(a.error)return r.status(500).json({error:a.error.message||"list_failed"});let s=a.data||[];try{let e=await i.supabaseServer.auth?.admin?.listUsers?.({page:1,perPage:1e3}),t=e?.data?.users||e?.users||[],r=new Map;for(let e of t){let t=String(e?.id||""),a=String(e?.email||"");t&&a&&r.set(t,a)}for(let e of s){let t=r.get(String(e.user_id))||null;e.email=t}}catch{}return r.json({ok:!0,items:s})}if("PATCH"!==t.method)return r.status(405).json({error:"method_not_allowed"});if(!await l(t,r,"admin-kyc"))return;let d=String(t.body?.userId||""),u=String(t.body?.status||"").toLowerCase(),c=t.body?.level,p="number"==typeof c?c:void 0;if(!d||!["approved","rejected","pending"].includes(u))return r.status(400).json({error:"invalid_payload"});let f=new Date().toISOString(),m={kyc_status:u},y={kyc_decision_at:f};"rejected"===u&&(y.kyc_reject_reason=String(t.body?.reason||"")),"number"==typeof p&&(y.kyc_level=p);let g=!1,w=await i.supabaseServer.from("profiles").update(m).eq("user_id",d).select("user_id").maybeSingle();!w.error&&w.data&&(await i.supabaseServer.from("profiles").update(y).eq("user_id",d),g=!0);let h={...m,...y},v=await i.supabaseServer.from("profiles").update(h).eq("user_id",d).select("user_id").maybeSingle();!v.error&&v.data&&(g=!0);let S=w.error?.message||v.error?.message||(g?"":"update_failed");if(!g&&"update_failed"===S)try{let e=await i.supabaseServer.from("profiles").upsert({user_id:d,kyc_status:u},{onConflict:"user_id"}).select("user_id").maybeSingle();if(e.error||!e.data)return r.status(500).json({error:e.error?.message||S});try{await i.supabaseServer.from("profiles").update(y).eq("user_id",d)}catch{}g=!0}catch(e){return r.status(500).json({error:e?.message||S})}if(!g)return r.status(500).json({error:S||"update_failed"});try{let t="approved"===u?"KYC Approved":"rejected"===u?"KYC Rejected":"KYC Updated",r="approved"===u?"Your identity verification has been approved. Withdrawals and advanced features are now unlocked.":"rejected"===u?`Your KYC was rejected${y.kyc_reject_reason?`: ${y.kyc_reject_reason}`:""}. Please resubmit with correct details.`:"Your KYC status has been updated.",a=await n.default.notification.create({data:{userId:d,type:"kyc_status",title:t,message:r,read:!1}});try{let{publish:t}=await e.A(22530);await t(`user:${d}`,{id:a.id,type:a.type,title:a.title,message:a.message,createdAt:a.createdAt})}catch{}}catch{}return r.json({ok:!0})}e.s(["config",0,{api:{bodyParser:!0}},"default",()=>d]),r()}catch(e){r(e)}},!1),74590,e=>e.a(async(t,r)=>{try{var a=e.i(26747),s=e.i(90406),i=e.i(44898),n=e.i(62950),o=e.i(26858),d=e.i(7031),l=e.i(81927),u=e.i(46432),c=t([o]);[o]=c.then?(await c)():c;let f=(0,n.hoist)(o,"default"),m=(0,n.hoist)(o,"config"),y=new i.PagesAPIRouteModule({definition:{kind:s.RouteKind.PAGES_API,page:"/api/admin/kyc",pathname:"/api/admin/kyc",bundlePath:"",filename:""},userland:o,distDir:".next",relativeProjectDir:""});async function p(e,t,r){y.isDev&&(0,u.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let s="/api/admin/kyc";s=s.replace(/\/index$/,"")||"/";let i=await y.prepare(e,t,{srcPage:s});if(!i){t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve());return}let{query:n,params:o,prerenderManifest:c,routerServerContext:p}=i;try{let r=e.method||"GET",a=(0,d.getTracer)(),i=a.getActiveScopeSpan(),u=y.instrumentationOnRequestError.bind(y),f=async i=>y.render(e,t,{query:{...n,...o},params:o,allowedRevalidateHeaderKeys:[],multiZoneDraftMode:!1,trustHostHeader:!1,previewProps:c.preview,propagateError:!1,dev:y.isDev,page:"/api/admin/kyc",internalRevalidate:null==p?void 0:p.revalidate,onError:(...t)=>u(e,...t)}).finally(()=>{if(!i)return;i.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let e=a.getRootSpanAttributes();if(!e)return;if(e.get("next.span_type")!==l.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${e.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let n=e.get("next.route");if(n){let e=`${r} ${n}`;i.setAttributes({"next.route":n,"http.route":n,"next.span_name":e}),i.updateName(e)}else i.updateName(`${r} ${s}`)});i?await f(i):await a.withPropagatedContext(e.headers,()=>a.trace(l.BaseServerSpan.handleRequest,{spanName:`${r} ${s}`,kind:d.SpanKind.SERVER,attributes:{"http.method":r,"http.target":e.url}},f))}catch(e){if(y.isDev)throw e;(0,a.sendError)(t,500,"Internal Server Error")}finally{null==r.waitUntil||r.waitUntil.call(r,Promise.resolve())}}e.s(["config",0,m,"default",0,f,"handler",()=>p]),r()}catch(e){r(e)}},!1),22530,e=>{e.v(t=>Promise.all(["server/chunks/[root-of-the-server]__39ab9f14._.js"].map(t=>e.l(t))).then(()=>t(57729)))}];

//# sourceMappingURL=%5Broot-of-the-server%5D__c13b422a._.js.map