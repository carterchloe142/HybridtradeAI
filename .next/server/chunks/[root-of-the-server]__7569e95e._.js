module.exports=[94131,(e,t,r)=>{t.exports=e.x("@supabase/supabase-js",()=>require("@supabase/supabase-js"))},30772,e=>{"use strict";let t;var r=e.i(94131);let a=process.env.SUPABASE_URL||"https://wdlcttgfwoejqynlylpv.supabase.co",i=process.env.SUPABASE_SERVICE_ROLE_KEY||"",s=!!(a&&i),n=s?(0,r.createClient)(a,i):{auth:{getUser:t=async()=>{throw Error("supabase_service_not_configured")}},from:()=>({select:t,insert:t,update:t,delete:t,eq:()=>({select:t,insert:t,update:t,delete:t}),order:()=>({select:t}),range:()=>({select:t}),maybeSingle:t})};e.s(["supabaseServer",0,n,"supabaseServiceReady",0,s])},55750,e=>{"use strict";let t=new Map;function r(e){return async function(r,a,i){let s=(r.headers["x-forwarded-for"]||"").split(",")[0].trim()||r.socket?.remoteAddress||"unknown",n=`${s}:${i}`,o=Date.now(),l=t.get(n);if(!l||o>l.resetAt)return t.set(n,{count:1,resetAt:o+e.windowMs}),a.setHeader("X-RateLimit-Remaining",String(e.max-1)),!0;if(l.count>=e.max){let e=l.resetAt-o;return a.setHeader("Retry-After",String(Math.ceil(e/1e3))),a.status(429).json({error:"Too many requests"}),!1}return l.count+=1,t.set(n,l),a.setHeader("X-RateLimit-Remaining",String(e.max-l.count)),!0}}e.s(["createRateLimiter",()=>r])},10996,e=>{"use strict";var t=e.i(26747),r=e.i(90406),a=e.i(44898),i=e.i(62950),s=e.i(55750),n=e.i(30772);let o=(0,s.createRateLimiter)({windowMs:6e4,max:20});function l(e){let t=/^data:(.+);base64,(.*)$/.exec(e||"");if(!t)throw Error("invalid_data_url");let r=t[1],a=t[2];return{mime:r,buffer:Buffer.from(a,"base64")}}async function u(e,t){if("POST"!==e.method)return t.status(405).json({error:"method_not_allowed"});if(await o(e,t,"kyc-upload"))try{let r=String(e.headers.authorization||""),a=r.startsWith("Bearer ")?r.slice(7):"";if(!a)return t.status(401).json({error:"unauthorized"});let{data:i,error:s}=await n.supabaseServer.auth.getUser(a);if(s||!i?.user?.id)return t.status(401).json({error:"invalid_token"});let o=String(i.user.id),u=e.body,p=String(u?.idFileDataUrl||""),d=String(u?.selfieNeutralDataUrl||""),f=String(u?.selfieSmileDataUrl||""),c=String(u?.selfieLeftDataUrl||""),g=String(u?.selfieRightDataUrl||""),m=u?.payload||{};if(!p||!d||!f||!c||!g)return t.status(400).json({error:"missing_files"});try{let e=await n.supabaseServer.storage.getBucket?.("kyc");e?.data?.name==="kyc"?await n.supabaseServer.storage.updateBucket?.("kyc",{public:!1,fileSizeLimit:"10MB",allowedMimeTypes:["image/jpeg","image/png","application/pdf","application/json","text/plain"]}):await n.supabaseServer.storage.createBucket?.("kyc",{public:!1,fileSizeLimit:"10MB",allowedMimeTypes:["image/jpeg","image/png","application/pdf","application/json","text/plain"]})}catch{}let y=n.supabaseServer.storage.from("kyc"),{mime:w,buffer:h}=l(p),{mime:S,buffer:_}=l(d),{mime:v,buffer:b}=l(f),{mime:$,buffer:j}=l(c),{mime:R,buffer:x}=l(g),k=w.includes("pdf")?"pdf":w.includes("png")?"png":"jpg",E=e=>e.includes("png")?"png":"jpg",A=`${o}/id.${k}`,P=`${o}/selfie_neutral.${E(S)}`,U=`${o}/selfie_smile.${E(v)}`,T=`${o}/selfie_left.${E($)}`,B=`${o}/selfie_right.${E(R)}`,D=`${o}/data.json`,q=await y.upload(A,h,{upsert:!0,contentType:w});if(q.error)return t.status(500).json({error:`id_upload_failed:${q.error.message}`});let M=await y.upload(P,_,{upsert:!0,contentType:S});if(M.error)return t.status(500).json({error:`selfie_neutral_upload_failed:${M.error.message}`});let L=await y.upload(U,b,{upsert:!0,contentType:v});if(L.error)return t.status(500).json({error:`selfie_smile_upload_failed:${L.error.message}`});let H=await y.upload(T,j,{upsert:!0,contentType:$});if(H.error)return t.status(500).json({error:`selfie_left_upload_failed:${H.error.message}`});let N=await y.upload(B,x,{upsert:!0,contentType:R});if(N.error)return t.status(500).json({error:`selfie_right_upload_failed:${N.error.message}`});let z=Buffer.from(JSON.stringify({...m}),"utf8");if((await y.upload(D,z,{upsert:!0,contentType:"application/json"})).error){let e=await y.upload(D,z,{upsert:!0,contentType:"text/plain"});if(e.error)return t.status(500).json({error:`data_upload_failed:${e.error.message}`})}return t.json({ok:!0})}catch(e){return t.status(500).json({error:e?.message||"server_error"})}}e.s(["config",0,{api:{bodyParser:{sizeLimit:"25mb"}}},"default",()=>u],56609);var p=e.i(56609),d=e.i(7031),f=e.i(81927),c=e.i(46432);let g=(0,i.hoist)(p,"default"),m=(0,i.hoist)(p,"config"),y=new a.PagesAPIRouteModule({definition:{kind:r.RouteKind.PAGES_API,page:"/api/kyc/upload",pathname:"/api/kyc/upload",bundlePath:"",filename:""},userland:p,distDir:".next",relativeProjectDir:""});async function w(e,r,a){y.isDev&&(0,c.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let i="/api/kyc/upload";i=i.replace(/\/index$/,"")||"/";let s=await y.prepare(e,r,{srcPage:i});if(!s){r.statusCode=400,r.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve());return}let{query:n,params:o,prerenderManifest:l,routerServerContext:u}=s;try{let t=e.method||"GET",a=(0,d.getTracer)(),s=a.getActiveScopeSpan(),p=y.instrumentationOnRequestError.bind(y),c=async s=>y.render(e,r,{query:{...n,...o},params:o,allowedRevalidateHeaderKeys:[],multiZoneDraftMode:!1,trustHostHeader:!1,previewProps:l.preview,propagateError:!1,dev:y.isDev,page:"/api/kyc/upload",internalRevalidate:null==u?void 0:u.revalidate,onError:(...t)=>p(e,...t)}).finally(()=>{if(!s)return;s.setAttributes({"http.status_code":r.statusCode,"next.rsc":!1});let e=a.getRootSpanAttributes();if(!e)return;if(e.get("next.span_type")!==f.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${e.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let n=e.get("next.route");if(n){let e=`${t} ${n}`;s.setAttributes({"next.route":n,"http.route":n,"next.span_name":e}),s.updateName(e)}else s.updateName(`${t} ${i}`)});s?await c(s):await a.withPropagatedContext(e.headers,()=>a.trace(f.BaseServerSpan.handleRequest,{spanName:`${t} ${i}`,kind:d.SpanKind.SERVER,attributes:{"http.method":t,"http.target":e.url}},c))}catch(e){if(y.isDev)throw e;(0,t.sendError)(r,500,"Internal Server Error")}finally{null==a.waitUntil||a.waitUntil.call(a,Promise.resolve())}}e.s(["config",0,m,"default",0,g,"handler",()=>w],10996)}];

//# sourceMappingURL=%5Broot-of-the-server%5D__7569e95e._.js.map