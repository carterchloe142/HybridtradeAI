module.exports=[94131,(e,t,r)=>{t.exports=e.x("@supabase/supabase-js",()=>require("@supabase/supabase-js"))},82150,(e,t,r)=>{t.exports=e.x("@sentry/nextjs",()=>require("@sentry/nextjs"))},30772,e=>{"use strict";let t;var r=e.i(94131);let i=process.env.SUPABASE_URL||"https://wdlcttgfwoejqynlylpv.supabase.co",a=process.env.SUPABASE_SERVICE_ROLE_KEY||"",s=!!(i&&a),n=s?(0,r.createClient)(i,a):{auth:{getUser:t=async()=>{throw Error("supabase_service_not_configured")}},from:()=>({select:t,insert:t,update:t,delete:t,eq:()=>({select:t,insert:t,update:t,delete:t}),order:()=>({select:t}),range:()=>({select:t}),maybeSingle:t})};e.s(["supabaseServer",0,n,"supabaseServiceReady",0,s])},56798,e=>{"use strict";var t=e.i(30772);async function r(e){try{let r=String(e.headers.authorization||""),i=r.startsWith("Bearer ")?r.slice(7):"";if(!i)return{ok:!1,error:"Missing Authorization bearer token"};let{data:a,error:s}=await t.supabaseServer.auth.getUser(i);if(s||!a?.user?.id)return{ok:!1,error:"Invalid token"};let n=a.user.id,{data:o,error:d}=await t.supabaseServer.from("profiles").select("role,is_admin").eq("user_id",n).maybeSingle();if(d)return{ok:!1,error:"Profile lookup failed"};let u=String(o?.role||"").toLowerCase();if(!(o?.is_admin||"admin"===u))return{ok:!1,error:"Forbidden"};return{ok:!0,userId:n}}catch(e){return{ok:!1,error:e?.message||"Admin check failed"}}}e.s(["requireAdmin",()=>r])},72701,e=>{"use strict";function t(e,t,r){console.log(JSON.stringify({level:e,event:t,ts:new Date().toISOString(),...r}))}e.s(["logError",0,(e,r)=>t("error",e,r),"logInfo",0,(e,r)=>t("info",e,r),"logWarn",0,(e,r)=>t("warn",e,r)])},19924,e=>{"use strict";var t=e.i(26747),r=e.i(90406),i=e.i(44898),a=e.i(62950),s=e.i(30772),n=e.i(82150),o=e.i(72701);let d=Number(process.env.PLATFORM_FEE_PERCENT??7),u={starter:{ads_tasks:70,trading:30},pro:{trading:60,copy_trading:25,ads_tasks:15},elite:{trading:50,staking_yield:30,ai:20}};function l(e){if(!e)return{};if("string"==typeof e)try{return JSON.parse(e)}catch{return{}}return e}function p(e){return Number(e.toFixed(2))}async function c(e){(0,o.logInfo)("profit_distribution.start",{dryRun:!!e?.dryRun});let{data:t,error:r}=await s.supabaseServer.from("performance").select("id,week_ending,stream_rois").order("week_ending",{ascending:!1}).limit(1);if(r)return(0,o.logError)("profit_distribution.performance_fetch_failed",{error:r.message}),n.captureException(r),{ok:!1,error:"Failed to fetch performance",details:r.message};let i=t&&t[0]?t[0]:null;if(!i)return(0,o.logWarn)("profit_distribution.no_performance"),{ok:!1,error:"No performance data found â€” aborting"};let a=function(e){let t={};for(let[r,i]of Object.entries(e||{})){let e=r.trim().toLowerCase();t["ads"===e||"tasks"===e||"ads_tasks"===e?"ads_tasks":"hft"===e||"arbitrage"===e||"trading"===e?"trading":"staking"===e||"yield"===e||"staking_yield"===e?"staking_yield":"copytrading"===e||"copy_trading"===e?"copy_trading":"ai"===e?"ai":e]=Number(i)||0}return t}(l(i.stream_rois)),{data:c,error:f}=await s.supabaseServer.from("investments").select("id,user_id,plan_id,amount_usd,status").eq("status","active");if(f)return(0,o.logError)("profit_distribution.investments_fetch_failed",{error:f.message}),n.captureException(f),{ok:!1,error:"Failed to fetch investments",details:f.message};let m=[];for(let t of c||[])try{let{data:r}=await s.supabaseServer.from("profiles").select("kyc_status,referrer_id").eq("user_id",t.user_id).maybeSingle(),n=r?.kyc_status??null;if("approved"!==n){m.push({investmentId:t.id,action:"skipped_kyc"});continue}let{data:c}=await s.supabaseServer.from("profit_logs").select("id").eq("investment_id",t.id).eq("week_ending",i.week_ending).limit(1);if(c&&c.length>0){m.push({investmentId:t.id,action:"skipped_duplicate_week"});continue}let f=u[t.plan_id]||{},{data:_}=await s.supabaseServer.from("plans").select("id,allocations").eq("id",t.plan_id).limit(1),g=l(_?.[0]?.allocations);g&&Object.keys(g).length>0&&(f=g);let b=0;for(let e of Object.keys(f)){let t=Number(f[e]||0),r=Number(a[e]||0);b+=t/100*r}let v=Number(t.amount_usd)*(b/100),w=d/100*v,y=p(v-w);if(!e?.dryRun){let{data:e}=await s.supabaseServer.from("wallets").select("id,amount").eq("user_id",t.user_id).eq("currency","USD").maybeSingle();e?.id?await s.supabaseServer.from("wallets").update({amount:Number(e.amount)+y}).eq("id",e.id):await s.supabaseServer.from("wallets").insert({user_id:t.user_id,currency:"USD",amount:y})}e?.dryRun||await s.supabaseServer.from("profit_logs").insert({user_id:t.user_id,plan_id:t.plan_id,investment_id:t.id,week_ending:i.week_ending,weighted_pct:b,gross_profit:p(v),fee:p(w),net_profit:y,stream_rois:a}),e?.dryRun||await s.supabaseServer.from("transactions").insert({user_id:t.user_id,type:"roi",amount_usd:y,meta:{investment_id:t.id,weighted_pct:b,platform_fee_pct:d,week_ending:i.week_ending}});let S=r?.referrer_id||null;if(S&&!e?.dryRun){let e="elite"===t.plan_id?.1:"pro"===t.plan_id?.07:.05,r=p(y*e);if(r>0){let{data:e}=await s.supabaseServer.from("wallets").select("id,amount").eq("user_id",S).eq("currency","USD").maybeSingle();e?.id?await s.supabaseServer.from("wallets").update({amount:Number(e.amount)+r}).eq("id",e.id):await s.supabaseServer.from("wallets").insert({user_id:S,currency:"USD",amount:r}),await s.supabaseServer.from("transactions").insert({user_id:S,type:"referral_credit",amount_usd:r,meta:{source_user_id:t.user_id,investment_id:t.id}})}}m.push({investmentId:t.id,action:e?.dryRun?"dry_run":"credited",netProfit:y,weightedPct:b}),(0,o.logInfo)("profit_distribution.credited",{investmentId:t.id,weekEnding:i.week_ending,netProfit:y})}catch(e){m.push({investmentId:t.id,action:"error",error:e?.message||String(e)}),(0,o.logError)("profit_distribution.error",{investmentId:t.id,error:e?.message||String(e)}),n.captureException(e)}return(0,o.logInfo)("profit_distribution.complete",{count:m.length,feePercent:d,weekEnding:i.week_ending}),{ok:!0,results:m,feePercent:d,week_ending:i.week_ending}}var f=e.i(56798);async function m(e,t){if("POST"!==e.method)return t.status(405).json({error:"Method not allowed"});let r=await (0,f.requireAdmin)(e);if(!r.ok)return t.status(401).json({error:r.error||"Unauthorized"});let i="true"===String(e.query.dryRun||e.body?.dryRun||"").toLowerCase();try{let e=await c({dryRun:i});if(!e.ok)return t.status(500).json(e);return t.status(200).json({...e,dryRun:i})}catch(e){return t.status(500).json({ok:!1,error:e?.message||"Distribution failed"})}}e.s(["default",()=>m],4776);var _=e.i(4776),g=e.i(7031),b=e.i(81927),v=e.i(46432);let w=(0,a.hoist)(_,"default"),y=(0,a.hoist)(_,"config"),S=new i.PagesAPIRouteModule({definition:{kind:r.RouteKind.PAGES_API,page:"/api/admin/distribute-profits.disabled",pathname:"/api/admin/distribute-profits.disabled",bundlePath:"",filename:""},userland:_,distDir:".next",relativeProjectDir:""});async function h(e,r,i){S.isDev&&(0,v.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let a="/api/admin/distribute-profits.disabled";a=a.replace(/\/index$/,"")||"/";let s=await S.prepare(e,r,{srcPage:a});if(!s){r.statusCode=400,r.end("Bad Request"),null==i.waitUntil||i.waitUntil.call(i,Promise.resolve());return}let{query:n,params:o,prerenderManifest:d,routerServerContext:u}=s;try{let t=e.method||"GET",i=(0,g.getTracer)(),s=i.getActiveScopeSpan(),l=S.instrumentationOnRequestError.bind(S),p=async s=>S.render(e,r,{query:{...n,...o},params:o,allowedRevalidateHeaderKeys:[],multiZoneDraftMode:!1,trustHostHeader:!1,previewProps:d.preview,propagateError:!1,dev:S.isDev,page:"/api/admin/distribute-profits.disabled",internalRevalidate:null==u?void 0:u.revalidate,onError:(...t)=>l(e,...t)}).finally(()=>{if(!s)return;s.setAttributes({"http.status_code":r.statusCode,"next.rsc":!1});let e=i.getRootSpanAttributes();if(!e)return;if(e.get("next.span_type")!==b.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${e.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let n=e.get("next.route");if(n){let e=`${t} ${n}`;s.setAttributes({"next.route":n,"http.route":n,"next.span_name":e}),s.updateName(e)}else s.updateName(`${t} ${a}`)});s?await p(s):await i.withPropagatedContext(e.headers,()=>i.trace(b.BaseServerSpan.handleRequest,{spanName:`${t} ${a}`,kind:g.SpanKind.SERVER,attributes:{"http.method":t,"http.target":e.url}},p))}catch(e){if(S.isDev)throw e;(0,t.sendError)(r,500,"Internal Server Error")}finally{null==i.waitUntil||i.waitUntil.call(i,Promise.resolve())}}e.s(["config",0,y,"default",0,w,"handler",()=>h],19924)}];

//# sourceMappingURL=%5Broot-of-the-server%5D__a1cf5c53._.js.map