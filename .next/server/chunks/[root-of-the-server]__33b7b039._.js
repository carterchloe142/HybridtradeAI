module.exports=[59639,(e,t,r)=>{t.exports=e.x("node:process",()=>require("node:process"))},50227,(e,t,r)=>{t.exports=e.x("node:path",()=>require("node:path"))},57764,(e,t,r)=>{t.exports=e.x("node:url",()=>require("node:url"))},4733,e=>e.a(async(t,r)=>{try{let t=await e.y("@prisma/client/runtime/library");e.n(t),r()}catch(e){r(e)}},!0),94131,(e,t,r)=>{t.exports=e.x("@supabase/supabase-js",()=>require("@supabase/supabase-js"))},30772,e=>{"use strict";let t;var r=e.i(94131);let a=process.env.SUPABASE_URL||"https://wdlcttgfwoejqynlylpv.supabase.co",i=process.env.SUPABASE_SERVICE_ROLE_KEY||"",s=!!(a&&i),n=s?(0,r.createClient)(a,i):{auth:{getUser:t=async()=>{throw Error("supabase_service_not_configured")}},from:()=>({select:t,insert:t,update:t,delete:t,eq:()=>({select:t,insert:t,update:t,delete:t}),order:()=>({select:t}),range:()=>({select:t}),maybeSingle:t})};e.s(["supabaseServer",0,n,"supabaseServiceReady",0,s])},56798,e=>{"use strict";var t=e.i(30772);async function r(e){try{let r=String(e.headers.authorization||""),a=r.startsWith("Bearer ")?r.slice(7):"";if(!a)return{ok:!1,error:"Missing Authorization bearer token"};let{data:i,error:s}=await t.supabaseServer.auth.getUser(a);if(s||!i?.user?.id)return{ok:!1,error:"Invalid token"};let n=i.user.id,{data:o,error:d}=await t.supabaseServer.from("profiles").select("role,is_admin").eq("user_id",n).maybeSingle();if(d)return{ok:!1,error:"Profile lookup failed"};let u=String(o?.role||"").toLowerCase();if(!(o?.is_admin||"admin"===u))return{ok:!1,error:"Forbidden"};return{ok:!0,userId:n}}catch(e){return{ok:!1,error:e?.message||"Admin check failed"}}}e.s(["requireAdmin",()=>r])},55750,e=>{"use strict";let t=new Map;function r(e){return async function(r,a,i){let s=(r.headers["x-forwarded-for"]||"").split(",")[0].trim()||r.socket?.remoteAddress||"unknown",n=`${s}:${i}`,o=Date.now(),d=t.get(n);if(!d||o>d.resetAt)return t.set(n,{count:1,resetAt:o+e.windowMs}),a.setHeader("X-RateLimit-Remaining",String(e.max-1)),!0;if(d.count>=e.max){let e=d.resetAt-o;return a.setHeader("Retry-After",String(Math.ceil(e/1e3))),a.status(429).json({error:"Too many requests"}),!1}return d.count+=1,t.set(n,d),a.setHeader("X-RateLimit-Remaining",String(e.max-d.count)),!0}}e.s(["createRateLimiter",()=>r])},46652,e=>e.a(async(t,r)=>{try{var a=e.i(82911),i=e.i(55750),s=e.i(56798),n=e.i(30772),o=t([a]);[a]=o.then?(await o)():o;let c=(0,i.createRateLimiter)({windowMs:6e4,max:5});async function d(t,r){if("GET"===t.method){let e=await (0,s.requireAdmin)(t);if(!e.ok)return r.status(403).json({error:e.error||"forbidden"});let i=Math.max(1,Number(t.query.page||"1")),o=Math.min(100,Math.max(1,Number(t.query.limit||"25"))),d=(i-1)*o;try{let[e,t]=await Promise.all([a.default.adminAction.findMany({where:{action:"MANUAL_CREDIT"},orderBy:{createdAt:"desc"},skip:d,take:o}),a.default.adminAction.count({where:{action:"MANUAL_CREDIT"}})]);return r.json({actions:e,total:t,page:i,limit:o})}catch{}let{data:u,error:l,count:c}=await n.supabaseServer.from("transactions").select("id,user_id,amount,currency,meta,created_at",{count:"exact"}).eq("type","admin_credit").order("created_at",{ascending:!1}).range(d,d+o-1);if(l)return r.json({actions:[],total:0,page:i,limit:o});let m=(u||[]).map(e=>({id:String(e.id),adminId:String(e.meta?.adminId||""),userId:String(e.user_id||""),amount:String(e.amount??"0"),action:"MANUAL_CREDIT",note:String(e.meta?.description||""),status:e?.meta?.pending?"PENDING":"COMPLETED",createdAt:String(e.created_at||new Date().toISOString())}));return r.json({actions:m,total:c??m.length,page:i,limit:o})}if("POST"!==t.method)return r.status(405).json({error:"method_not_allowed"});if(!await c(t,r,"admin-credit-user"))return;let i=await (0,s.requireAdmin)(t);if(!i.ok||!i.userId)return r.status(403).json({error:i.error||"forbidden"});let o=i.userId,{userId:d,email:u,amount:m}=t.body??{},p=t.body?.note??t.body?.description??void 0;if("number"!=typeof m)return r.status(400).json({error:"missing_fields"});if(m<=0)return r.status(400).json({error:"invalid_amount"});if("true"!==String(process.env.ENABLE_MANUAL_CREDITS||"false").toLowerCase())return r.status(403).json({error:"manual_credits_disabled"});let f=Number(process.env.MANUAL_CREDIT_APPROVAL_THRESHOLD||"0");try{let t=await l({userId:d,email:u});if(!t)return r.status(400).json({error:"invalid_user_identifier"});if(f&&m>f)try{let e=await a.default.adminAction.create({data:{adminId:o,userId:t,amount:m.toString(),action:"MANUAL_CREDIT",note:p||"Pending approval due to threshold",status:"PENDING"}});return r.status(202).json({status:"pending",action:e})}catch{let{data:e}=await n.supabaseServer.from("transactions").insert({user_id:t,type:"admin_credit",amount:m,currency:"USD",meta:{description:p??null,adminId:o,pending:!0}}).select().maybeSingle();return r.status(202).json({status:"pending",action:e||null})}let{data:i,error:s}=await n.supabaseServer.from("wallets").select("id,balance").eq("user_id",t).eq("currency","USD").maybeSingle();if(s)throw Error(`wallet_select_failed:${s.message}`);let c=i?.id,w=Number(i?.balance??0);if(!c){let{data:e,error:r}=await n.supabaseServer.from("wallets").insert({user_id:t,currency:"USD",balance:0}).select().maybeSingle();if(r)throw Error(`wallet_create_failed:${r.message}`);c=e?.id,w=0}let g=Number((w+m).toFixed(8)),{error:h}=await n.supabaseServer.from("wallets").update({balance:g}).eq("id",c);if(h)throw Error(`wallet_update_failed:${h.message}`);try{let{error:e}=await n.supabaseServer.from("transactions").insert({user_id:t,type:"admin_credit",amount:m,currency:"USD",meta:{description:p??null,adminId:o}});if(e)throw Error(`transactions_insert_failed:${e.message}`)}catch{}let _=null;try{_=await a.default.walletTransaction.create({data:{walletId:c,amount:m.toString(),type:"CREDIT",source:"admin_credit",note:p||null,performedBy:o}})}catch{}try{await a.default.adminAction.create({data:{adminId:o,userId:t,amount:m.toString(),action:"MANUAL_CREDIT",note:p||null,status:"COMPLETED"}})}catch{}try{let r=await a.default.notification.create({data:{userId:t,type:"manual_credit",title:"Manual Credit",message:`Your wallet was credited with $${m.toFixed(2)} USD`,read:!1}});try{let{publish:a}=await e.A(22530);await a(`user:${t}`,{id:r.id,type:r.type,title:r.title,message:r.message,createdAt:r.createdAt})}catch{}}catch{}return r.json({balance:g,transaction:_})}catch(t){console.error("wallets api error",t);let e=String(t?.message||"credit_failed");if(e.includes("wallet_select_failed")||e.includes("wallet_create_failed")||e.includes("wallet_update_failed"))return r.status(500).json({error:e});return e.includes("transactions_insert_failed"),r.status(500).json({error:e})}}function u(e){return!!e&&/.+@.+\..+/.test(e)}async function l({userId:e,email:t}){if(e&&/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(e))return e;let r=u(t)?t:u(e)?e:"";if(r){let{data:e,error:t}=await n.supabaseServer.from("profiles").select("user_id").eq("email",r).maybeSingle();if(!t&&e?.user_id)return e.user_id;try{let e=await n.supabaseServer.auth?.admin?.listUsers?.({page:1,perPage:200}),t=(e?.data?.users||e?.users||[]).find(e=>String(e?.email||"").toLowerCase()===r.toLowerCase());if(t?.id)return String(t.id)}catch{}}if(e&&e.startsWith("c")&&e.length>=24)try{let t=await a.default.user.findUnique({where:{id:e}}),r=t?.email;if(r){let{data:e,error:t}=await n.supabaseServer.from("profiles").select("user_id").eq("email",r).maybeSingle();if(!t&&e?.user_id)return e.user_id;try{let e=await n.supabaseServer.auth?.admin?.listUsers?.({page:1,perPage:200}),t=(e?.data?.users||e?.users||[]).find(e=>String(e?.email||"").toLowerCase()===String(r).toLowerCase());if(t?.id)return String(t.id)}catch{}}}catch{}return""}e.s(["config",0,{api:{bodyParser:!0}},"default",()=>d]),r()}catch(e){r(e)}},!1),17976,e=>e.a(async(t,r)=>{try{var a=e.i(26747),i=e.i(90406),s=e.i(44898),n=e.i(62950),o=e.i(46652),d=e.i(7031),u=e.i(81927),l=e.i(46432),c=t([o]);[o]=c.then?(await c)():c;let p=(0,n.hoist)(o,"default"),f=(0,n.hoist)(o,"config"),w=new s.PagesAPIRouteModule({definition:{kind:i.RouteKind.PAGES_API,page:"/api/admin/credit-user",pathname:"/api/admin/credit-user",bundlePath:"",filename:""},userland:o,distDir:".next",relativeProjectDir:""});async function m(e,t,r){w.isDev&&(0,l.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let i="/api/admin/credit-user";i=i.replace(/\/index$/,"")||"/";let s=await w.prepare(e,t,{srcPage:i});if(!s){t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve());return}let{query:n,params:o,prerenderManifest:c,routerServerContext:m}=s;try{let r=e.method||"GET",a=(0,d.getTracer)(),s=a.getActiveScopeSpan(),l=w.instrumentationOnRequestError.bind(w),p=async s=>w.render(e,t,{query:{...n,...o},params:o,allowedRevalidateHeaderKeys:[],multiZoneDraftMode:!1,trustHostHeader:!1,previewProps:c.preview,propagateError:!1,dev:w.isDev,page:"/api/admin/credit-user",internalRevalidate:null==m?void 0:m.revalidate,onError:(...t)=>l(e,...t)}).finally(()=>{if(!s)return;s.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let e=a.getRootSpanAttributes();if(!e)return;if(e.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${e.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let n=e.get("next.route");if(n){let e=`${r} ${n}`;s.setAttributes({"next.route":n,"http.route":n,"next.span_name":e}),s.updateName(e)}else s.updateName(`${r} ${i}`)});s?await p(s):await a.withPropagatedContext(e.headers,()=>a.trace(u.BaseServerSpan.handleRequest,{spanName:`${r} ${i}`,kind:d.SpanKind.SERVER,attributes:{"http.method":r,"http.target":e.url}},p))}catch(e){if(w.isDev)throw e;(0,a.sendError)(t,500,"Internal Server Error")}finally{null==r.waitUntil||r.waitUntil.call(r,Promise.resolve())}}e.s(["config",0,f,"default",0,p,"handler",()=>m]),r()}catch(e){r(e)}},!1),22530,e=>{e.v(t=>Promise.all(["server/chunks/[root-of-the-server]__39ab9f14._.js"].map(t=>e.l(t))).then(()=>t(57729)))}];

//# sourceMappingURL=%5Broot-of-the-server%5D__33b7b039._.js.map