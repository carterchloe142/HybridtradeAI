{"version":3,"sources":["turbopack:///[project]/src/lib/redis.ts","turbopack:///[project]/src/lib/sse.ts"],"sourcesContent":["import Redis from 'ioredis'\n\nexport function createClient(url = process.env.REDIS_URL || 'redis://localhost:6379') {\n  const tlsOpts = url.startsWith('rediss://') ? { tls: { rejectUnauthorized: false } } : {}\n  const client = new Redis(url, tlsOpts as any)\n  client.on('error', () => {})\n  client.on('connect', () => {})\n  client.on('ready', () => {})\n  client.on('end', () => {})\n  return client\n}\n\nexport const redis = createClient()\n\nexport function duplicate(client: Redis) {\n  const dup = client.duplicate()\n  dup.on('error', () => {})\n  dup.on('connect', () => {})\n  dup.on('ready', () => {})\n  dup.on('end', () => {})\n  return dup\n}\n\nexport const pub = duplicate(redis)\nexport const sub = duplicate(redis)\n\nexport function createSubscriber(url = process.env.REDIS_URL || 'redis://localhost:6379') {\n  return duplicate(createClient(url))\n}\n","import type Redis from 'ioredis'\nimport { pub, sub } from './redis'\n\nexport async function publish(channel: string, payload: unknown) {\n  const data = JSON.stringify(payload)\n  await pub.publish(channel, data)\n}\n\nexport function subscribe(channel: string, handler: (payload: any) => void, client: Redis = sub) {\n  client.subscribe(channel)\n  const onMessage = (ch: string, message: string) => {\n    if (ch !== channel) return\n    try {\n      handler(JSON.parse(message))\n    } catch {\n      handler(message)\n    }\n  }\n  client.on('message', onMessage)\n  return () => {\n    client.off('message', onMessage)\n    client.unsubscribe(channel)\n  }\n}\n\nexport const HEARTBEAT_MS = 25000\n\nexport function encodeSSE(data: any, id?: string, event?: string) {\n  const payload = typeof data === 'string' ? data : JSON.stringify(data)\n  const idLine = id ? `id: ${id}\\n` : ''\n  const eventLine = event ? `event: ${event}\\n` : ''\n  return new TextEncoder().encode(`${idLine}${eventLine}data: ${payload}\\n\\n`)\n}\n"],"names":[],"mappings":"wGAAA,IAAA,EAAA,EAAA,CAAA,CAAA,OAYO,IAAM,EAVN,AAUc,SAVL,AAAa,EAAM,QAAQ,GAAG,CAAC,SAAS,EAAI,wBAAwB,EAClF,IAAM,EAAU,EAAI,UAAU,CAAC,aAAe,CAAE,IAAK,CAAE,mBAAoB,EAAM,CAAE,EAAI,CAAC,EAClF,EAAS,IAAI,EAAA,OAAK,CAAC,EAAK,GAK9B,OAJA,EAAO,EAAE,CAAC,QAAS,KAAO,GAC1B,EAAO,EAAE,CAAC,UAAW,KAAO,GAC5B,EAAO,EAAE,CAAC,QAAS,KAAO,GAC1B,EAAO,EAAE,CAAC,MAAO,KAAO,GACjB,CACT,IAIO,SAAS,EAAU,CAAa,EACrC,IAAM,EAAM,EAAO,SAAS,GAK5B,OAJA,EAAI,EAAE,CAAC,QAAS,KAAO,GACvB,EAAI,EAAE,CAAC,UAAW,KAAO,GACzB,EAAI,EAAE,CAAC,QAAS,KAAO,GACvB,EAAI,EAAE,CAAC,MAAO,KAAO,GACd,CACT,CAEO,IAAM,EAAM,EAAU,GAChB,EAAM,EAAU,GCrBtB,eAAe,EAAQ,CAAe,CAAE,CAAgB,EAC7D,IAAM,EAAO,KAAK,SAAS,CAAC,EAC5B,OAAM,EAAI,OAAO,CAAC,EAAS,EAC7B,CAEO,SAAS,EAAU,CAAe,CAAE,CAA+B,CAAE,EAAgB,CAAG,EAC7F,EAAO,SAAS,CAAC,GACjB,IAAM,EAAY,CAAC,EAAY,KAC7B,GAAI,IAAO,EACX,GAAI,CACF,EAAQ,CAFU,IAEL,KAAK,CAAC,GACrB,CAAE,KAAM,CACN,EAAQ,EACV,CACF,EAEA,OADA,EAAO,EAAE,CAAC,UAAW,GACd,KACL,EAAO,GAAG,CAAC,UAAW,GACtB,EAAO,WAAW,CAAC,EACrB,CACF,CAIO,SAAS,EAAU,CAAS,CAAE,CAAW,CAAE,CAAc,EAC9D,IAAM,EAA0B,UAAhB,OAAO,EAAoB,EAAO,KAAK,SAAS,CAAC,GAC3D,EAAS,EAAK,CAAC,IAAI,EAAE,GAAG;AAAE,CAAC,CAAG,GAC9B,EAAY,EAAQ,CAAC,OAAO,EAAE,MAAM;AAAE,CAAC,CAAG,GAChD,OAAO,IAAI,cAAc,MAAM,CAAC,CAAA,EAAG,EAAA,EAAS,EAAU,MAAM,EAAE,QAAQ;AAAA;AAAI,CAAC,CAC7E,uBAP4B"}