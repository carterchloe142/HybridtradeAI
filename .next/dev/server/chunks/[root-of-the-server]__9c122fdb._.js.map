{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 22, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/Documents/trae_projects/HYBRID%20TRADE%20AI/lib/supabaseServer.ts"],"sourcesContent":["import { createClient } from '@supabase/supabase-js';\n\nconst url = process.env.SUPABASE_URL || process.env.NEXT_PUBLIC_SUPABASE_URL || '';\nconst serviceKey = process.env.SUPABASE_SERVICE_ROLE_KEY || process.env.SUPABASE_ANON_KEY || process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY || '';\n\nexport const supabaseServer = createClient(url, serviceKey);\n"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM,MAAM,QAAQ,GAAG,CAAC,YAAY,oFAA4C;AAChF,MAAM,aAAa,QAAQ,GAAG,CAAC,yBAAyB,IAAI,QAAQ,GAAG,CAAC,iBAAiB,4PAAiD;AAEnI,MAAM,iBAAiB,IAAA,iKAAY,EAAC,KAAK","debugId":null}},
    {"offset": {"line": 45, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/Documents/trae_projects/HYBRID%20TRADE%20AI/lib/adminAuth.ts"],"sourcesContent":["import type { NextApiRequest } from 'next';\nimport { supabaseServer } from './supabaseServer';\n\nexport type AdminCheck = { ok: boolean; userId?: string; error?: string };\n\nexport async function requireAdmin(req: NextApiRequest): Promise<AdminCheck> {\n  try {\n    const auth = String(req.headers.authorization || '');\n    const token = auth.startsWith('Bearer ') ? auth.slice(7) : '';\n    if (!token) return { ok: false, error: 'Missing Authorization bearer token' };\n\n    const { data: userData, error: userErr } = await supabaseServer.auth.getUser(token);\n    if (userErr || !userData?.user?.id) return { ok: false, error: 'Invalid token' };\n    const userId = userData.user.id;\n\n    const { data: profile, error } = await supabaseServer\n      .from('profiles')\n      .select('role,is_admin')\n      .eq('user_id', userId)\n      .maybeSingle();\n    if (error) return { ok: false, error: 'Profile lookup failed' };\n    const role = String(profile?.role || '').toLowerCase();\n    const isAdmin = Boolean(profile?.is_admin) || role === 'admin';\n    if (!isAdmin) return { ok: false, error: 'Forbidden' };\n    return { ok: true, userId };\n  } catch (e: any) {\n    return { ok: false, error: e?.message || 'Admin check failed' };\n  }\n}\n\n"],"names":[],"mappings":";;;;AACA;;AAIO,eAAe,aAAa,GAAmB;IACpD,IAAI;QACF,MAAM,OAAO,OAAO,IAAI,OAAO,CAAC,aAAa,IAAI;QACjD,MAAM,QAAQ,KAAK,UAAU,CAAC,aAAa,KAAK,KAAK,CAAC,KAAK;QAC3D,IAAI,CAAC,OAAO,OAAO;YAAE,IAAI;YAAO,OAAO;QAAqC;QAE5E,MAAM,EAAE,MAAM,QAAQ,EAAE,OAAO,OAAO,EAAE,GAAG,MAAM,mLAAc,CAAC,IAAI,CAAC,OAAO,CAAC;QAC7E,IAAI,WAAW,CAAC,UAAU,MAAM,IAAI,OAAO;YAAE,IAAI;YAAO,OAAO;QAAgB;QAC/E,MAAM,SAAS,SAAS,IAAI,CAAC,EAAE;QAE/B,MAAM,EAAE,MAAM,OAAO,EAAE,KAAK,EAAE,GAAG,MAAM,mLAAc,CAClD,IAAI,CAAC,YACL,MAAM,CAAC,iBACP,EAAE,CAAC,WAAW,QACd,WAAW;QACd,IAAI,OAAO,OAAO;YAAE,IAAI;YAAO,OAAO;QAAwB;QAC9D,MAAM,OAAO,OAAO,SAAS,QAAQ,IAAI,WAAW;QACpD,MAAM,UAAU,QAAQ,SAAS,aAAa,SAAS;QACvD,IAAI,CAAC,SAAS,OAAO;YAAE,IAAI;YAAO,OAAO;QAAY;QACrD,OAAO;YAAE,IAAI;YAAM;QAAO;IAC5B,EAAE,OAAO,GAAQ;QACf,OAAO;YAAE,IAAI;YAAO,OAAO,GAAG,WAAW;QAAqB;IAChE;AACF","debugId":null}},
    {"offset": {"line": 93, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/Documents/trae_projects/HYBRID%20TRADE%20AI/pages/api/admin/performance.ts"],"sourcesContent":["import type { NextApiRequest, NextApiResponse } from 'next';\nimport { supabaseServer } from '../../../lib/supabaseServer';\nimport { z } from 'zod';\nimport { requireAdmin } from '../../../lib/adminAuth';\n\nconst RoiSchema = z.record(z.number().nonnegative());\nconst BodySchema = z.object({\n  weekEnding: z.string().refine(s => !isNaN(Date.parse(s)), { message: 'Invalid date' }),\n  streamRois: RoiSchema\n});\n\nexport default async function handler(req: NextApiRequest, res: NextApiResponse) {\n  if (req.method !== 'POST') return res.status(405).json({ error: 'Method not allowed' });\n  const admin = await requireAdmin(req);\n  if (!admin.ok) return res.status(401).json({ error: admin.error || 'Unauthorized' });\n  const parse = BodySchema.safeParse(req.body || {});\n  if (!parse.success) return res.status(400).json({ error: 'Invalid payload', issues: parse.error.issues });\n  const { weekEnding, streamRois } = parse.data;\n\n  try {\n    const payload = { week_ending: weekEnding, stream_rois: streamRois };\n    // Try upsert by week_ending if unique constraint exists; otherwise fallback to insert\n    let result: any = null;\n    try {\n      const { data, error } = await supabaseServer\n        .from('performance')\n        .upsert(payload, { onConflict: 'week_ending' })\n        .select()\n        .maybeSingle();\n      if (error) throw error;\n      result = data;\n    } catch (e: any) {\n      const { data, error } = await supabaseServer\n        .from('performance')\n        .insert(payload)\n        .select()\n        .maybeSingle();\n      if (error) return res.status(500).json({ error: 'Failed to insert performance', details: error.message });\n      result = data;\n    }\n\n    return res.status(200).json({ ok: true, performance: result });\n  } catch (err: any) {\n    return res.status(500).json({ ok: false, error: err?.message || 'Failed to upsert performance' });\n  }\n}\n"],"names":[],"mappings":";;;;AACA;AACA;AACA;;;;;;;;AAEA,MAAM,YAAY,2GAAC,CAAC,MAAM,CAAC,2GAAC,CAAC,MAAM,GAAG,WAAW;AACjD,MAAM,aAAa,2GAAC,CAAC,MAAM,CAAC;IAC1B,YAAY,2GAAC,CAAC,MAAM,GAAG,MAAM,CAAC,CAAA,IAAK,CAAC,MAAM,KAAK,KAAK,CAAC,KAAK;QAAE,SAAS;IAAe;IACpF,YAAY;AACd;AAEe,eAAe,QAAQ,GAAmB,EAAE,GAAoB;IAC7E,IAAI,IAAI,MAAM,KAAK,QAAQ,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;QAAE,OAAO;IAAqB;IACrF,MAAM,QAAQ,MAAM,IAAA,4KAAY,EAAC;IACjC,IAAI,CAAC,MAAM,EAAE,EAAE,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;QAAE,OAAO,MAAM,KAAK,IAAI;IAAe;IAClF,MAAM,QAAQ,WAAW,SAAS,CAAC,IAAI,IAAI,IAAI,CAAC;IAChD,IAAI,CAAC,MAAM,OAAO,EAAE,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;QAAE,OAAO;QAAmB,QAAQ,MAAM,KAAK,CAAC,MAAM;IAAC;IACvG,MAAM,EAAE,UAAU,EAAE,UAAU,EAAE,GAAG,MAAM,IAAI;IAE7C,IAAI;QACF,MAAM,UAAU;YAAE,aAAa;YAAY,aAAa;QAAW;QACnE,sFAAsF;QACtF,IAAI,SAAc;QAClB,IAAI;YACF,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,mLAAc,CACzC,IAAI,CAAC,eACL,MAAM,CAAC,SAAS;gBAAE,YAAY;YAAc,GAC5C,MAAM,GACN,WAAW;YACd,IAAI,OAAO,MAAM;YACjB,SAAS;QACX,EAAE,OAAO,GAAQ;YACf,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,mLAAc,CACzC,IAAI,CAAC,eACL,MAAM,CAAC,SACP,MAAM,GACN,WAAW;YACd,IAAI,OAAO,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;gBAAgC,SAAS,MAAM,OAAO;YAAC;YACvG,SAAS;QACX;QAEA,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,IAAI;YAAM,aAAa;QAAO;IAC9D,EAAE,OAAO,KAAU;QACjB,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,IAAI;YAAO,OAAO,KAAK,WAAW;QAA+B;IACjG;AACF","debugId":null}}]
}