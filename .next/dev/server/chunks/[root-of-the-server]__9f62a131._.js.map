{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 10, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/Documents/trae_projects/HYBRID%20TRADE%20AI/lib/rateLimit.ts"],"sourcesContent":["import type { NextApiRequest, NextApiResponse } from 'next';\n\ntype LimiterOptions = { windowMs: number; max: number };\ntype Hit = { count: number; resetAt: number };\n\nconst store = new Map<string, Hit>();\n\nfunction getIp(req: NextApiRequest) {\n  const xfwd = (req.headers['x-forwarded-for'] || '') as string;\n  const ip = xfwd.split(',')[0].trim();\n  return ip || (req.socket as any)?.remoteAddress || 'unknown';\n}\n\nexport function createRateLimiter(opts: LimiterOptions) {\n  return async function check(req: NextApiRequest, res: NextApiResponse, key: string) {\n    const ip = getIp(req);\n    const id = `${ip}:${key}`;\n    const now = Date.now();\n    const hit = store.get(id);\n    if (!hit || now > hit.resetAt) {\n      store.set(id, { count: 1, resetAt: now + opts.windowMs });\n      res.setHeader('X-RateLimit-Remaining', String(opts.max - 1));\n      return true;\n    }\n    if (hit.count >= opts.max) {\n      const retryMs = hit.resetAt - now;\n      res.setHeader('Retry-After', String(Math.ceil(retryMs / 1000)));\n      res.status(429).json({ error: 'Too many requests' });\n      return false;\n    }\n    hit.count += 1;\n    store.set(id, hit);\n    res.setHeader('X-RateLimit-Remaining', String(opts.max - hit.count));\n    return true;\n  };\n}\n"],"names":[],"mappings":";;;;AAKA,MAAM,QAAQ,IAAI;AAElB,SAAS,MAAM,GAAmB;IAChC,MAAM,OAAQ,IAAI,OAAO,CAAC,kBAAkB,IAAI;IAChD,MAAM,KAAK,KAAK,KAAK,CAAC,IAAI,CAAC,EAAE,CAAC,IAAI;IAClC,OAAO,MAAO,IAAI,MAAM,EAAU,iBAAiB;AACrD;AAEO,SAAS,kBAAkB,IAAoB;IACpD,OAAO,eAAe,MAAM,GAAmB,EAAE,GAAoB,EAAE,GAAW;QAChF,MAAM,KAAK,MAAM;QACjB,MAAM,KAAK,GAAG,GAAG,CAAC,EAAE,KAAK;QACzB,MAAM,MAAM,KAAK,GAAG;QACpB,MAAM,MAAM,MAAM,GAAG,CAAC;QACtB,IAAI,CAAC,OAAO,MAAM,IAAI,OAAO,EAAE;YAC7B,MAAM,GAAG,CAAC,IAAI;gBAAE,OAAO;gBAAG,SAAS,MAAM,KAAK,QAAQ;YAAC;YACvD,IAAI,SAAS,CAAC,yBAAyB,OAAO,KAAK,GAAG,GAAG;YACzD,OAAO;QACT;QACA,IAAI,IAAI,KAAK,IAAI,KAAK,GAAG,EAAE;YACzB,MAAM,UAAU,IAAI,OAAO,GAAG;YAC9B,IAAI,SAAS,CAAC,eAAe,OAAO,KAAK,IAAI,CAAC,UAAU;YACxD,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAAoB;YAClD,OAAO;QACT;QACA,IAAI,KAAK,IAAI;QACb,MAAM,GAAG,CAAC,IAAI;QACd,IAAI,SAAS,CAAC,yBAAyB,OAAO,KAAK,GAAG,GAAG,IAAI,KAAK;QAClE,OAAO;IACT;AACF","debugId":null}},
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/Documents/trae_projects/HYBRID%20TRADE%20AI/lib/supabaseServer.ts"],"sourcesContent":["import { createClient } from '@supabase/supabase-js'\n\nconst url = process.env.SUPABASE_URL || process.env.NEXT_PUBLIC_SUPABASE_URL || ''\nconst serviceKey = process.env.SUPABASE_SERVICE_ROLE_KEY || ''\n\nexport const supabaseServiceReady = Boolean(url && serviceKey)\n\nfunction createDisabledClient(): any {\n  const err = async () => { throw new Error('supabase_service_not_configured') }\n  const from = () => ({\n    select: err,\n    insert: err,\n    update: err,\n    delete: err,\n    eq: () => ({ select: err, insert: err, update: err, delete: err }),\n    order: () => ({ select: err }),\n    range: () => ({ select: err }),\n    maybeSingle: err,\n  })\n  return { auth: { getUser: err }, from }\n}\n\nexport const supabaseServer = supabaseServiceReady ? createClient(url, serviceKey) : createDisabledClient()\n"],"names":[],"mappings":";;;;;;AAAA;;AAEA,MAAM,MAAM,QAAQ,GAAG,CAAC,YAAY,oFAA4C;AAChF,MAAM,aAAa,QAAQ,GAAG,CAAC,yBAAyB,IAAI;AAErD,MAAM,uBAAuB,QAAQ,OAAO;AAEnD,SAAS;IACP,MAAM,MAAM;QAAc,MAAM,IAAI,MAAM;IAAmC;IAC7E,MAAM,OAAO,IAAM,CAAC;YAClB,QAAQ;YACR,QAAQ;YACR,QAAQ;YACR,QAAQ;YACR,IAAI,IAAM,CAAC;oBAAE,QAAQ;oBAAK,QAAQ;oBAAK,QAAQ;oBAAK,QAAQ;gBAAI,CAAC;YACjE,OAAO,IAAM,CAAC;oBAAE,QAAQ;gBAAI,CAAC;YAC7B,OAAO,IAAM,CAAC;oBAAE,QAAQ;gBAAI,CAAC;YAC7B,aAAa;QACf,CAAC;IACD,OAAO;QAAE,MAAM;YAAE,SAAS;QAAI;QAAG;IAAK;AACxC;AAEO,MAAM,iBAAiB,uBAAuB,IAAA,iKAAY,EAAC,KAAK,cAAc","debugId":null}},
    {"offset": {"line": 104, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/Documents/trae_projects/HYBRID%20TRADE%20AI/pages/api/kyc/submit.ts"],"sourcesContent":["import type { NextApiRequest, NextApiResponse } from 'next'\nimport { createRateLimiter } from '../../../lib/rateLimit'\nimport { supabaseServer } from '../../../lib/supabaseServer'\n\nconst limiter = createRateLimiter({ windowMs: 60_000, max: 10 })\n\nexport default async function handler(req: NextApiRequest, res: NextApiResponse) {\n  if (req.method !== 'POST') return res.status(405).json({ error: 'method_not_allowed' })\n  if (!(await limiter(req, res, 'kyc-submit'))) return\n\n  try {\n    const auth = String(req.headers.authorization || '')\n    const token = auth.startsWith('Bearer ') ? auth.slice(7) : ''\n    if (!token) return res.status(401).json({ error: 'unauthorized' })\n    const { data: userData, error: userErr } = await supabaseServer.auth.getUser(token)\n    if (userErr || !userData?.user?.id) return res.status(401).json({ error: 'invalid_token' })\n    const userId = String(userData.user.id)\n\n    const levelRaw = (req.body as any)?.level\n    const level = typeof levelRaw === 'number' ? levelRaw : 1\n\n    const now = new Date().toISOString()\n    const base: any = { user_id: userId, kyc_status: 'pending', kyc_submitted_at: now }\n    const full: any = typeof level === 'number' ? { ...base, kyc_level: level } : base\n    const minimal: any = { user_id: userId, kyc_status: 'pending' }\n    let upsert = await supabaseServer\n      .from('profiles')\n      .upsert(full, { onConflict: 'user_id' })\n      .select('user_id')\n      .maybeSingle()\n    if (!upsert.error && upsert.data) return res.json({ ok: true })\n    upsert = await supabaseServer\n      .from('profiles')\n      .upsert(base, { onConflict: 'user_id' })\n      .select('user_id')\n      .maybeSingle()\n    if (!upsert.error && upsert.data) return res.json({ ok: true })\n    upsert = await supabaseServer\n      .from('profiles')\n      .upsert(minimal, { onConflict: 'user_id' })\n      .select('user_id')\n      .maybeSingle()\n    if (!upsert.error && upsert.data) return res.json({ ok: true })\n\n    let tryUpdateUser = await supabaseServer\n      .from('profiles')\n      .update(full)\n      .eq('user_id', userId)\n      .select('user_id')\n      .maybeSingle()\n    if (!tryUpdateUser.error && tryUpdateUser.data) return res.json({ ok: true })\n    tryUpdateUser = await supabaseServer\n      .from('profiles')\n      .update(base)\n      .eq('user_id', userId)\n      .select('user_id')\n      .maybeSingle()\n    if (!tryUpdateUser.error && tryUpdateUser.data) return res.json({ ok: true })\n    tryUpdateUser = await supabaseServer\n      .from('profiles')\n      .update(minimal)\n      .eq('user_id', userId)\n      .select('user_id')\n      .maybeSingle()\n    if (!tryUpdateUser.error && tryUpdateUser.data) return res.json({ ok: true })\n\n    // Skip update by primary key 'id' â€” not present in this schema\n\n    let insert = await supabaseServer\n      .from('profiles')\n      .insert(full)\n      .select('user_id')\n      .maybeSingle()\n    if (!insert.error && insert.data) return res.json({ ok: true })\n    insert = await supabaseServer\n      .from('profiles')\n      .insert(base)\n      .select('user_id')\n      .maybeSingle()\n    if (!insert.error && insert.data) return res.json({ ok: true })\n    insert = await supabaseServer\n      .from('profiles')\n      .insert(minimal)\n      .select('user_id')\n      .maybeSingle()\n    if (!insert.error && insert.data) return res.json({ ok: true })\n\n    const message = upsert.error?.message || tryUpdateUser.error?.message || insert.error?.message || 'unknown'\n    return res.status(500).json({ error: `submit_failed:${message}` })\n  } catch (e: any) {\n    return res.status(500).json({ error: e?.message || 'server_error' })\n  }\n}\n\nexport const config = { api: { bodyParser: true } }\n"],"names":[],"mappings":"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","debugId":null}}]
}