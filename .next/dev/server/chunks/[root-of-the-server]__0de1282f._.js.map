{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 16, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/Documents/trae_projects/HYBRID%20TRADE%20AI/lib/supabaseServer.ts"],"sourcesContent":["import { createClient } from '@supabase/supabase-js'\n\nconst url = process.env.SUPABASE_URL || process.env.NEXT_PUBLIC_SUPABASE_URL || ''\nconst serviceKey = process.env.SUPABASE_SERVICE_ROLE_KEY || ''\n\nexport const supabaseServiceReady = Boolean(url && serviceKey)\n\nfunction createDisabledClient(): any {\n  const err = async () => { throw new Error('supabase_service_not_configured') }\n  const from = () => ({\n    select: err,\n    insert: err,\n    update: err,\n    delete: err,\n    eq: () => ({ select: err, insert: err, update: err, delete: err }),\n    order: () => ({ select: err }),\n    range: () => ({ select: err }),\n    maybeSingle: err,\n  })\n  return { auth: { getUser: err }, from }\n}\n\nexport const supabaseServer = supabaseServiceReady ? createClient(url, serviceKey) : createDisabledClient()\n"],"names":[],"mappings":";;;;;;AAAA;;AAEA,MAAM,MAAM,QAAQ,GAAG,CAAC,YAAY,oFAA4C;AAChF,MAAM,aAAa,QAAQ,GAAG,CAAC,yBAAyB,IAAI;AAErD,MAAM,uBAAuB,QAAQ,OAAO;AAEnD,SAAS;IACP,MAAM,MAAM;QAAc,MAAM,IAAI,MAAM;IAAmC;IAC7E,MAAM,OAAO,IAAM,CAAC;YAClB,QAAQ;YACR,QAAQ;YACR,QAAQ;YACR,QAAQ;YACR,IAAI,IAAM,CAAC;oBAAE,QAAQ;oBAAK,QAAQ;oBAAK,QAAQ;oBAAK,QAAQ;gBAAI,CAAC;YACjE,OAAO,IAAM,CAAC;oBAAE,QAAQ;gBAAI,CAAC;YAC7B,OAAO,IAAM,CAAC;oBAAE,QAAQ;gBAAI,CAAC;YAC7B,aAAa;QACf,CAAC;IACD,OAAO;QAAE,MAAM;YAAE,SAAS;QAAI;QAAG;IAAK;AACxC;AAEO,MAAM,iBAAiB,uBAAuB,IAAA,iKAAY,EAAC,KAAK,cAAc","debugId":null}},
    {"offset": {"line": 62, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/Documents/trae_projects/HYBRID%20TRADE%20AI/lib/rateLimit.ts"],"sourcesContent":["import type { NextApiRequest, NextApiResponse } from 'next';\n\ntype LimiterOptions = { windowMs: number; max: number };\ntype Hit = { count: number; resetAt: number };\n\nconst store = new Map<string, Hit>();\n\nfunction getIp(req: NextApiRequest) {\n  const xfwd = (req.headers['x-forwarded-for'] || '') as string;\n  const ip = xfwd.split(',')[0].trim();\n  return ip || (req.socket as any)?.remoteAddress || 'unknown';\n}\n\nexport function createRateLimiter(opts: LimiterOptions) {\n  return async function check(req: NextApiRequest, res: NextApiResponse, key: string) {\n    const ip = getIp(req);\n    const id = `${ip}:${key}`;\n    const now = Date.now();\n    const hit = store.get(id);\n    if (!hit || now > hit.resetAt) {\n      store.set(id, { count: 1, resetAt: now + opts.windowMs });\n      res.setHeader('X-RateLimit-Remaining', String(opts.max - 1));\n      return true;\n    }\n    if (hit.count >= opts.max) {\n      const retryMs = hit.resetAt - now;\n      res.setHeader('Retry-After', String(Math.ceil(retryMs / 1000)));\n      res.status(429).json({ error: 'Too many requests' });\n      return false;\n    }\n    hit.count += 1;\n    store.set(id, hit);\n    res.setHeader('X-RateLimit-Remaining', String(opts.max - hit.count));\n    return true;\n  };\n}\n"],"names":[],"mappings":";;;;AAKA,MAAM,QAAQ,IAAI;AAElB,SAAS,MAAM,GAAmB;IAChC,MAAM,OAAQ,IAAI,OAAO,CAAC,kBAAkB,IAAI;IAChD,MAAM,KAAK,KAAK,KAAK,CAAC,IAAI,CAAC,EAAE,CAAC,IAAI;IAClC,OAAO,MAAO,IAAI,MAAM,EAAU,iBAAiB;AACrD;AAEO,SAAS,kBAAkB,IAAoB;IACpD,OAAO,eAAe,MAAM,GAAmB,EAAE,GAAoB,EAAE,GAAW;QAChF,MAAM,KAAK,MAAM;QACjB,MAAM,KAAK,GAAG,GAAG,CAAC,EAAE,KAAK;QACzB,MAAM,MAAM,KAAK,GAAG;QACpB,MAAM,MAAM,MAAM,GAAG,CAAC;QACtB,IAAI,CAAC,OAAO,MAAM,IAAI,OAAO,EAAE;YAC7B,MAAM,GAAG,CAAC,IAAI;gBAAE,OAAO;gBAAG,SAAS,MAAM,KAAK,QAAQ;YAAC;YACvD,IAAI,SAAS,CAAC,yBAAyB,OAAO,KAAK,GAAG,GAAG;YACzD,OAAO;QACT;QACA,IAAI,IAAI,KAAK,IAAI,KAAK,GAAG,EAAE;YACzB,MAAM,UAAU,IAAI,OAAO,GAAG;YAC9B,IAAI,SAAS,CAAC,eAAe,OAAO,KAAK,IAAI,CAAC,UAAU;YACxD,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAAoB;YAClD,OAAO;QACT;QACA,IAAI,KAAK,IAAI;QACb,MAAM,GAAG,CAAC,IAAI;QACd,IAAI,SAAS,CAAC,yBAAyB,OAAO,KAAK,GAAG,GAAG,IAAI,KAAK;QAClE,OAAO;IACT;AACF","debugId":null}},
    {"offset": {"line": 104, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/Documents/trae_projects/HYBRID%20TRADE%20AI/lib/kyc.ts"],"sourcesContent":["import { supabaseServer } from './supabaseServer';\n\nexport type KycStatus = 'approved' | 'pending' | 'rejected' | null;\n\nexport async function getKycStatus(userId: string): Promise<KycStatus> {\n  const { data, error } = await supabaseServer\n    .from('profiles')\n    .select('kyc_status')\n    .eq('user_id', userId)\n    .maybeSingle();\n  if (error) return null;\n  return (data?.kyc_status as KycStatus) ?? null;\n}\n"],"names":[],"mappings":";;;;AAAA;;AAIO,eAAe,aAAa,MAAc;IAC/C,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,gIAAc,CACzC,IAAI,CAAC,YACL,MAAM,CAAC,cACP,EAAE,CAAC,WAAW,QACd,WAAW;IACd,IAAI,OAAO,OAAO;IAClB,OAAO,AAAC,MAAM,cAA4B;AAC5C","debugId":null}},
    {"offset": {"line": 131, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/Documents/trae_projects/HYBRID%20TRADE%20AI/pages/api/withdraw.ts"],"sourcesContent":["import type { NextApiRequest, NextApiResponse } from 'next';\nimport { supabaseServer } from '../../lib/supabaseServer';\nimport { createRateLimiter } from '../../lib/rateLimit';\nimport { getKycStatus } from '../../lib/kyc';\nimport { z } from 'zod';\n\nconst WithdrawSchema = z.object({\n  userId: z.string().min(1),\n  amount: z.number().positive(),\n  currency: z.enum(['USD', 'EUR', 'NGN', 'BTC', 'ETH']),\n  cycleActive: z.boolean().optional()\n});\n\nexport default async function handler(req: NextApiRequest, res: NextApiResponse) {\n  if (req.method !== 'POST') return res.status(405).json({ error: 'Method not allowed' });\n  const limiter = createRateLimiter({\n    windowMs: Number(process.env.RATE_LIMIT_WINDOW_MS ?? 15_000),\n    max: Number(process.env.RATE_LIMIT_MAX ?? 20)\n  });\n  const ok = await limiter(req, res, 'withdraw');\n  if (!ok) return;\n  const parsed = WithdrawSchema.safeParse(req.body || {});\n  if (!parsed.success) return res.status(400).json({ error: 'Invalid payload', issues: parsed.error.issues });\n  const { userId, amount, currency, cycleActive } = parsed.data;\n  // Enforce KYC approval before any withdrawal\n  const kyc = await getKycStatus(userId);\n  if (kyc !== 'approved') return res.status(403).json({ error: 'KYC required. Please complete verification.' });\n  // Enforce waiting period if investment cycle is ongoing\n  if (cycleActive) return res.status(400).json({ error: 'Withdrawal blocked: cycle in progress. Try after distribution.' });\n  // Large withdrawal hold policy\n  const holdThreshold = Number(process.env.WITHDRAW_HOLD_THRESHOLD_USD ?? 2000);\n  if (Number(amount) > holdThreshold) {\n    await supabaseServer\n      .from('transactions')\n      .insert({ user_id: userId, type: 'withdraw_request', amount_usd: amount, meta: { currency, status: 'pending', reason: 'large_withdrawal_hold' } });\n    return res.status(202).json({ ok: true, message: 'Withdrawal request submitted and pending admin approval.' });\n  }\n  // Fetch wallet\n  const { data: wallet, error: wErr } = await supabaseServer\n    .from('wallets')\n    .select('id,amount')\n    .eq('user_id', userId)\n    .eq('currency', currency)\n    .maybeSingle();\n  if (wErr) return res.status(500).json({ error: 'Wallet fetch failed' });\n  if (!wallet || Number(wallet.amount) < Number(amount)) return res.status(400).json({ error: 'Insufficient balance' });\n\n  const { error: updErr } = await supabaseServer\n    .from('wallets')\n    .update({ amount: Number(wallet.amount) - Number(amount) })\n    .eq('id', wallet.id);\n  if (updErr) return res.status(500).json({ error: 'Failed to update wallet' });\n\n  const { error: txErr } = await supabaseServer\n    .from('transactions')\n    .insert({ user_id: userId, type: 'withdraw', amount_usd: amount, meta: { currency } });\n  if (txErr) return res.status(500).json({ error: 'Failed to record withdrawal' });\n\n  return res.status(200).json({ ok: true, message: `Withdrawal of ${amount} ${currency} recorded.` });\n}\n"],"names":[],"mappings":"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","debugId":null}}]
}