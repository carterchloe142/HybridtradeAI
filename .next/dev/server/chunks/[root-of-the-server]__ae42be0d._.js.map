{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 10, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/Documents/trae_projects/HYBRID%20TRADE%20AI/lib/rateLimit.ts"],"sourcesContent":["import type { NextApiRequest, NextApiResponse } from 'next';\n\ntype LimiterOptions = { windowMs: number; max: number };\ntype Hit = { count: number; resetAt: number };\n\nconst store = new Map<string, Hit>();\n\nfunction getIp(req: NextApiRequest) {\n  const xfwd = (req.headers['x-forwarded-for'] || '') as string;\n  const ip = xfwd.split(',')[0].trim();\n  return ip || (req.socket as any)?.remoteAddress || 'unknown';\n}\n\nexport function createRateLimiter(opts: LimiterOptions) {\n  return async function check(req: NextApiRequest, res: NextApiResponse, key: string) {\n    const ip = getIp(req);\n    const id = `${ip}:${key}`;\n    const now = Date.now();\n    const hit = store.get(id);\n    if (!hit || now > hit.resetAt) {\n      store.set(id, { count: 1, resetAt: now + opts.windowMs });\n      res.setHeader('X-RateLimit-Remaining', String(opts.max - 1));\n      return true;\n    }\n    if (hit.count >= opts.max) {\n      const retryMs = hit.resetAt - now;\n      res.setHeader('Retry-After', String(Math.ceil(retryMs / 1000)));\n      res.status(429).json({ error: 'Too many requests' });\n      return false;\n    }\n    hit.count += 1;\n    store.set(id, hit);\n    res.setHeader('X-RateLimit-Remaining', String(opts.max - hit.count));\n    return true;\n  };\n}\n"],"names":[],"mappings":";;;;AAKA,MAAM,QAAQ,IAAI;AAElB,SAAS,MAAM,GAAmB;IAChC,MAAM,OAAQ,IAAI,OAAO,CAAC,kBAAkB,IAAI;IAChD,MAAM,KAAK,KAAK,KAAK,CAAC,IAAI,CAAC,EAAE,CAAC,IAAI;IAClC,OAAO,MAAO,IAAI,MAAM,EAAU,iBAAiB;AACrD;AAEO,SAAS,kBAAkB,IAAoB;IACpD,OAAO,eAAe,MAAM,GAAmB,EAAE,GAAoB,EAAE,GAAW;QAChF,MAAM,KAAK,MAAM;QACjB,MAAM,KAAK,GAAG,GAAG,CAAC,EAAE,KAAK;QACzB,MAAM,MAAM,KAAK,GAAG;QACpB,MAAM,MAAM,MAAM,GAAG,CAAC;QACtB,IAAI,CAAC,OAAO,MAAM,IAAI,OAAO,EAAE;YAC7B,MAAM,GAAG,CAAC,IAAI;gBAAE,OAAO;gBAAG,SAAS,MAAM,KAAK,QAAQ;YAAC;YACvD,IAAI,SAAS,CAAC,yBAAyB,OAAO,KAAK,GAAG,GAAG;YACzD,OAAO;QACT;QACA,IAAI,IAAI,KAAK,IAAI,KAAK,GAAG,EAAE;YACzB,MAAM,UAAU,IAAI,OAAO,GAAG;YAC9B,IAAI,SAAS,CAAC,eAAe,OAAO,KAAK,IAAI,CAAC,UAAU;YACxD,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAAoB;YAClD,OAAO;QACT;QACA,IAAI,KAAK,IAAI;QACb,MAAM,GAAG,CAAC,IAAI;QACd,IAAI,SAAS,CAAC,yBAAyB,OAAO,KAAK,GAAG,GAAG,IAAI,KAAK;QAClE,OAAO;IACT;AACF","debugId":null}},
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/Documents/trae_projects/HYBRID%20TRADE%20AI/lib/supabaseServer.ts"],"sourcesContent":["import { createClient } from '@supabase/supabase-js'\n\nconst url = process.env.SUPABASE_URL || process.env.NEXT_PUBLIC_SUPABASE_URL || ''\nconst serviceKey = process.env.SUPABASE_SERVICE_ROLE_KEY || ''\n\nexport const supabaseServiceReady = Boolean(url && serviceKey)\n\nfunction createDisabledClient(): any {\n  const err = async () => { throw new Error('supabase_service_not_configured') }\n  const from = () => ({\n    select: err,\n    insert: err,\n    update: err,\n    delete: err,\n    eq: () => ({ select: err, insert: err, update: err, delete: err }),\n    order: () => ({ select: err }),\n    range: () => ({ select: err }),\n    maybeSingle: err,\n  })\n  return { auth: { getUser: err }, from }\n}\n\nexport const supabaseServer = supabaseServiceReady ? createClient(url, serviceKey) : createDisabledClient()\n"],"names":[],"mappings":";;;;;;AAAA;;AAEA,MAAM,MAAM,QAAQ,GAAG,CAAC,YAAY,oFAA4C;AAChF,MAAM,aAAa,QAAQ,GAAG,CAAC,yBAAyB,IAAI;AAErD,MAAM,uBAAuB,QAAQ,OAAO;AAEnD,SAAS;IACP,MAAM,MAAM;QAAc,MAAM,IAAI,MAAM;IAAmC;IAC7E,MAAM,OAAO,IAAM,CAAC;YAClB,QAAQ;YACR,QAAQ;YACR,QAAQ;YACR,QAAQ;YACR,IAAI,IAAM,CAAC;oBAAE,QAAQ;oBAAK,QAAQ;oBAAK,QAAQ;oBAAK,QAAQ;gBAAI,CAAC;YACjE,OAAO,IAAM,CAAC;oBAAE,QAAQ;gBAAI,CAAC;YAC7B,OAAO,IAAM,CAAC;oBAAE,QAAQ;gBAAI,CAAC;YAC7B,aAAa;QACf,CAAC;IACD,OAAO;QAAE,MAAM;YAAE,SAAS;QAAI;QAAG;IAAK;AACxC;AAEO,MAAM,iBAAiB,uBAAuB,IAAA,iKAAY,EAAC,KAAK,cAAc","debugId":null}},
    {"offset": {"line": 104, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/Documents/trae_projects/HYBRID%20TRADE%20AI/pages/api/kyc/upload.ts"],"sourcesContent":["import type { NextApiRequest, NextApiResponse } from 'next'\nimport { createRateLimiter } from '../../../lib/rateLimit'\nimport { supabaseServer } from '../../../lib/supabaseServer'\n\nconst limiter = createRateLimiter({ windowMs: 60_000, max: 20 })\n\nfunction parseDataUrl(dataUrl: string): { mime: string; buffer: Buffer } {\n  const m = /^data:(.+);base64,(.*)$/.exec(dataUrl || '')\n  if (!m) throw new Error('invalid_data_url')\n  const mime = m[1]\n  const b64 = m[2]\n  const buffer = Buffer.from(b64, 'base64')\n  return { mime, buffer }\n}\n\nexport default async function handler(req: NextApiRequest, res: NextApiResponse) {\n  if (req.method !== 'POST') return res.status(405).json({ error: 'method_not_allowed' })\n  if (!(await limiter(req, res, 'kyc-upload'))) return\n\n  try {\n    const auth = String(req.headers.authorization || '')\n    const token = auth.startsWith('Bearer ') ? auth.slice(7) : ''\n    if (!token) return res.status(401).json({ error: 'unauthorized' })\n    const { data: userData, error: userErr } = await supabaseServer.auth.getUser(token)\n    if (userErr || !userData?.user?.id) return res.status(401).json({ error: 'invalid_token' })\n    const userId = String(userData.user.id)\n\n    const body = req.body as any\n    const idDataUrl = String(body?.idFileDataUrl || '')\n    const selfieNeutralDataUrl = String(body?.selfieNeutralDataUrl || '')\n    const selfieSmileDataUrl = String(body?.selfieSmileDataUrl || '')\n    const selfieLeftDataUrl = String(body?.selfieLeftDataUrl || '')\n    const selfieRightDataUrl = String(body?.selfieRightDataUrl || '')\n    const payload = body?.payload || {}\n\n    if (!idDataUrl || !selfieNeutralDataUrl || !selfieSmileDataUrl || !selfieLeftDataUrl || !selfieRightDataUrl) {\n      return res.status(400).json({ error: 'missing_files' })\n    }\n\n    const bucketName = 'kyc'\n    try {\n      const info: any = await (supabaseServer.storage as any).getBucket?.(bucketName)\n      const exists = Boolean(info?.data?.name === bucketName)\n      if (!exists) {\n        await (supabaseServer.storage as any).createBucket?.(bucketName, {\n          public: false,\n          fileSizeLimit: '10MB',\n          allowedMimeTypes: ['image/jpeg','image/png','application/pdf','application/json','text/plain'],\n        })\n      } else {\n        await (supabaseServer.storage as any).updateBucket?.(bucketName, {\n          public: false,\n          fileSizeLimit: '10MB',\n          allowedMimeTypes: ['image/jpeg','image/png','application/pdf','application/json','text/plain'],\n        })\n      }\n    } catch {}\n    const bucket = supabaseServer.storage.from(bucketName)\n\n    const { mime: idMime, buffer: idBuf } = parseDataUrl(idDataUrl)\n    const { mime: nMime, buffer: nBuf } = parseDataUrl(selfieNeutralDataUrl)\n    const { mime: sMime, buffer: sBuf } = parseDataUrl(selfieSmileDataUrl)\n    const { mime: lMime, buffer: lBuf } = parseDataUrl(selfieLeftDataUrl)\n    const { mime: rMime, buffer: rBuf } = parseDataUrl(selfieRightDataUrl)\n\n    const idExt = idMime.includes('pdf') ? 'pdf' : (idMime.includes('png') ? 'png' : 'jpg')\n    const selfieExt = (m: string) => (m.includes('png') ? 'png' : 'jpg')\n\n    const idPath = `${userId}/id.${idExt}`\n    const nPath = `${userId}/selfie_neutral.${selfieExt(nMime)}`\n    const sPath = `${userId}/selfie_smile.${selfieExt(sMime)}`\n    const lPath = `${userId}/selfie_left.${selfieExt(lMime)}`\n    const rPath = `${userId}/selfie_right.${selfieExt(rMime)}`\n    const jsonPath = `${userId}/data.json`\n\n    const idUp = await bucket.upload(idPath, idBuf, { upsert: true, contentType: idMime })\n    if (idUp.error) return res.status(500).json({ error: `id_upload_failed:${idUp.error.message}` })\n    const nUp = await bucket.upload(nPath, nBuf, { upsert: true, contentType: nMime })\n    if (nUp.error) return res.status(500).json({ error: `selfie_neutral_upload_failed:${nUp.error.message}` })\n    const sUp = await bucket.upload(sPath, sBuf, { upsert: true, contentType: sMime })\n    if (sUp.error) return res.status(500).json({ error: `selfie_smile_upload_failed:${sUp.error.message}` })\n    const lUp = await bucket.upload(lPath, lBuf, { upsert: true, contentType: lMime })\n    if (lUp.error) return res.status(500).json({ error: `selfie_left_upload_failed:${lUp.error.message}` })\n    const rUp = await bucket.upload(rPath, rBuf, { upsert: true, contentType: rMime })\n    if (rUp.error) return res.status(500).json({ error: `selfie_right_upload_failed:${rUp.error.message}` })\n\n    const payloadBlob = Buffer.from(JSON.stringify({ ...payload }), 'utf8')\n    const jsonUp = await bucket.upload(jsonPath, payloadBlob, { upsert: true, contentType: 'application/json' })\n    if (jsonUp.error) {\n      const jsonUpFallback = await bucket.upload(jsonPath, payloadBlob, { upsert: true, contentType: 'text/plain' })\n      if (jsonUpFallback.error) return res.status(500).json({ error: `data_upload_failed:${jsonUpFallback.error.message}` })\n    }\n\n    return res.json({ ok: true })\n  } catch (e: any) {\n    return res.status(500).json({ error: e?.message || 'server_error' })\n  }\n}\n\nexport const config = { api: { bodyParser: { sizeLimit: '25mb' } } }\n"],"names":[],"mappings":"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","debugId":null}}]
}