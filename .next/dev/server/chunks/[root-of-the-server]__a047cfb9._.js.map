{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 22, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/Documents/trae_projects/HYBRID%20TRADE%20AI/lib/supabaseServer.ts"],"sourcesContent":["import { createClient } from '@supabase/supabase-js';\n\nconst url = process.env.SUPABASE_URL || process.env.NEXT_PUBLIC_SUPABASE_URL || '';\nconst serviceKey = process.env.SUPABASE_SERVICE_ROLE_KEY || process.env.SUPABASE_ANON_KEY || process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY || '';\n\nexport const supabaseServer = createClient(url, serviceKey);\n"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM,MAAM,QAAQ,GAAG,CAAC,YAAY,oFAA4C;AAChF,MAAM,aAAa,QAAQ,GAAG,CAAC,yBAAyB,IAAI,QAAQ,GAAG,CAAC,iBAAiB,4PAAiD;AAEnI,MAAM,iBAAiB,IAAA,iKAAY,EAAC,KAAK","debugId":null}},
    {"offset": {"line": 35, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/Documents/trae_projects/HYBRID%20TRADE%20AI/backend/profit-engine.ts"],"sourcesContent":["import type { Balance, Plan } from '../types';\n\nexport const PLANS: Plan[] = [\n  {\n    id: 'starter',\n    name: 'Starter',\n    description: 'Entry plan allocating 70% Ads & Tasks and 30% Trading.',\n    weeklyRoi: 30, // mid of 21–40% range; actual ROI comes from admin streams\n    features: ['70% Ads & Tasks', '30% Trading', 'Task bonuses available']\n  },\n  {\n    id: 'pro',\n    name: 'Pro',\n    description: 'Balanced plan: 60% Trading, 25% Copy-Trading, 15% Ads & Tasks.',\n    weeklyRoi: 35, // mid of 25–45% range\n    features: ['60% Trading', '25% Copy-Trading', '15% Ads & Tasks', 'Premium education content']\n  },\n  {\n    id: 'elite',\n    name: 'Elite',\n    description: 'High-tier: 50% Trading, 30% Staking/Yield, 20% AI/Copy-Trading.',\n    weeklyRoi: 40, // mid of 30–50% range\n    features: ['Priority withdrawals', 'Beta access to new features', '50% Trading', '30% Staking/Yield', '20% AI/Copy-Trading']\n  }\n];\n\nexport type ReferralConfig = {\n  starter: number;\n  pro: number;\n  elite: number;\n};\n\nexport const referralConfig: ReferralConfig = { starter: 5, pro: 7, elite: 10 };\n\nexport function calculateWeeklyROI(amountUSD: number, planId: string): number {\n  const plan = PLANS.find(p => p.id === planId);\n  if (!plan) return 0;\n  const roi = amountUSD * (plan.weeklyRoi / 100);\n  return Number(roi.toFixed(2));\n}\n\nexport function calculateReferralCommission(downlineWeeklyRoiUSD: number, planId: string): number {\n  const pct = planId === 'pro' ? referralConfig.pro : planId === 'elite' ? referralConfig.elite : referralConfig.starter;\n  const commission = downlineWeeklyRoiUSD * (pct / 100);\n  return Number(commission.toFixed(2));\n}\n\n// Placeholder for cron / scheduled profit distribution\nexport async function distributeWeeklyProfits() {\n  // TODO: integrate with DB (Supabase) to: \n  // 1) fetch active investments\n  // 2) compute ROI per plan\n  // 3) credit wallets for profits and referrals\n  // 4) record transactions and update balances\n  return { ok: true, message: 'Scheduled distribution stub executed.' };\n}\n"],"names":[],"mappings":";;;;;;;;;;;;AAEO,MAAM,QAAgB;IAC3B;QACE,IAAI;QACJ,MAAM;QACN,aAAa;QACb,WAAW;QACX,UAAU;YAAC;YAAmB;YAAe;SAAyB;IACxE;IACA;QACE,IAAI;QACJ,MAAM;QACN,aAAa;QACb,WAAW;QACX,UAAU;YAAC;YAAe;YAAoB;YAAmB;SAA4B;IAC/F;IACA;QACE,IAAI;QACJ,MAAM;QACN,aAAa;QACb,WAAW;QACX,UAAU;YAAC;YAAwB;YAA+B;YAAe;YAAqB;SAAsB;IAC9H;CACD;AAQM,MAAM,iBAAiC;IAAE,SAAS;IAAG,KAAK;IAAG,OAAO;AAAG;AAEvE,SAAS,mBAAmB,SAAiB,EAAE,MAAc;IAClE,MAAM,OAAO,MAAM,IAAI,CAAC,CAAA,IAAK,EAAE,EAAE,KAAK;IACtC,IAAI,CAAC,MAAM,OAAO;IAClB,MAAM,MAAM,YAAY,CAAC,KAAK,SAAS,GAAG,GAAG;IAC7C,OAAO,OAAO,IAAI,OAAO,CAAC;AAC5B;AAEO,SAAS,4BAA4B,oBAA4B,EAAE,MAAc;IACtF,MAAM,MAAM,WAAW,QAAQ,eAAe,GAAG,GAAG,WAAW,UAAU,eAAe,KAAK,GAAG,eAAe,OAAO;IACtH,MAAM,aAAa,uBAAuB,CAAC,MAAM,GAAG;IACpD,OAAO,OAAO,WAAW,OAAO,CAAC;AACnC;AAGO,eAAe;IACpB,0CAA0C;IAC1C,8BAA8B;IAC9B,0BAA0B;IAC1B,8CAA8C;IAC9C,6CAA6C;IAC7C,OAAO;QAAE,IAAI;QAAM,SAAS;IAAwC;AACtE","debugId":null}},
    {"offset": {"line": 116, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/Documents/trae_projects/HYBRID%20TRADE%20AI/lib/adminAuth.ts"],"sourcesContent":["import type { NextApiRequest } from 'next';\nimport { supabaseServer } from './supabaseServer';\n\nexport type AdminCheck = { ok: boolean; userId?: string; error?: string };\n\nexport async function requireAdmin(req: NextApiRequest): Promise<AdminCheck> {\n  try {\n    const auth = String(req.headers.authorization || '');\n    const token = auth.startsWith('Bearer ') ? auth.slice(7) : '';\n    if (!token) return { ok: false, error: 'Missing Authorization bearer token' };\n\n    const { data: userData, error: userErr } = await supabaseServer.auth.getUser(token);\n    if (userErr || !userData?.user?.id) return { ok: false, error: 'Invalid token' };\n    const userId = userData.user.id;\n\n    const { data: profile, error } = await supabaseServer\n      .from('profiles')\n      .select('role,is_admin')\n      .eq('user_id', userId)\n      .maybeSingle();\n    if (error) return { ok: false, error: 'Profile lookup failed' };\n    const role = String(profile?.role || '').toLowerCase();\n    const isAdmin = Boolean(profile?.is_admin) || role === 'admin';\n    if (!isAdmin) return { ok: false, error: 'Forbidden' };\n    return { ok: true, userId };\n  } catch (e: any) {\n    return { ok: false, error: e?.message || 'Admin check failed' };\n  }\n}\n\n"],"names":[],"mappings":";;;;AACA;;AAIO,eAAe,aAAa,GAAmB;IACpD,IAAI;QACF,MAAM,OAAO,OAAO,IAAI,OAAO,CAAC,aAAa,IAAI;QACjD,MAAM,QAAQ,KAAK,UAAU,CAAC,aAAa,KAAK,KAAK,CAAC,KAAK;QAC3D,IAAI,CAAC,OAAO,OAAO;YAAE,IAAI;YAAO,OAAO;QAAqC;QAE5E,MAAM,EAAE,MAAM,QAAQ,EAAE,OAAO,OAAO,EAAE,GAAG,MAAM,mLAAc,CAAC,IAAI,CAAC,OAAO,CAAC;QAC7E,IAAI,WAAW,CAAC,UAAU,MAAM,IAAI,OAAO;YAAE,IAAI;YAAO,OAAO;QAAgB;QAC/E,MAAM,SAAS,SAAS,IAAI,CAAC,EAAE;QAE/B,MAAM,EAAE,MAAM,OAAO,EAAE,KAAK,EAAE,GAAG,MAAM,mLAAc,CAClD,IAAI,CAAC,YACL,MAAM,CAAC,iBACP,EAAE,CAAC,WAAW,QACd,WAAW;QACd,IAAI,OAAO,OAAO;YAAE,IAAI;YAAO,OAAO;QAAwB;QAC9D,MAAM,OAAO,OAAO,SAAS,QAAQ,IAAI,WAAW;QACpD,MAAM,UAAU,QAAQ,SAAS,aAAa,SAAS;QACvD,IAAI,CAAC,SAAS,OAAO;YAAE,IAAI;YAAO,OAAO;QAAY;QACrD,OAAO;YAAE,IAAI;YAAM;QAAO;IAC5B,EAAE,OAAO,GAAQ;QACf,OAAO;YAAE,IAAI;YAAO,OAAO,GAAG,WAAW;QAAqB;IAChE;AACF","debugId":null}},
    {"offset": {"line": 162, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/Documents/trae_projects/HYBRID%20TRADE%20AI/pages/api/admin/run-cycle.ts"],"sourcesContent":["import type { NextApiRequest, NextApiResponse } from 'next';\nimport { supabaseServer } from '../../../lib/supabaseServer';\nimport { PLANS, calculateWeeklyROI } from '../../../backend/profit-engine';\nimport { requireAdmin } from '../../../lib/adminAuth';\n\nfunction addDays(dateStr: string, days: number) {\n  const d = new Date(dateStr);\n  d.setDate(d.getDate() + days);\n  return d;\n}\n\nfunction getPlanRoiPct(planId: string): number {\n  const plan = PLANS.find(p => p.id === planId);\n  return plan?.weeklyRoi ?? 0;\n}\n\nexport default async function handler(req: NextApiRequest, res: NextApiResponse) {\n  if (req.method !== 'POST') return res.status(405).json({ error: 'Method not allowed' });\n  const admin = await requireAdmin(req);\n  if (!admin.ok) return res.status(401).json({ error: admin.error || 'Unauthorized' });\n  const serviceFeePct = Number(process.env.SERVICE_FEE_PCT ?? 5);\n\n  const { data: investments, error } = await supabaseServer\n    .from('investments')\n    .select('id,user_id,plan_id,amount_usd,status,created_at')\n    .eq('status', 'active');\n  if (error) return res.status(500).json({ error: 'Failed to fetch investments' });\n\n  const now = new Date();\n  const results: any[] = [];\n\n  for (const inv of (investments || [])) {\n    const start = new Date(inv.created_at);\n    const profitDate = addDays(inv.created_at, 7);\n    const maturityDate = addDays(inv.created_at, 14);\n\n    // Check if ROI already credited\n    const { data: roiTx } = await supabaseServer\n      .from('transactions')\n      .select('id')\n      .eq('user_id', inv.user_id)\n      .eq('type', 'roi')\n      .contains('meta', { investment_id: inv.id })\n      .limit(1);\n\n    // Credit ROI at day 7\n    if (now >= profitDate && (!roiTx || roiTx.length === 0)) {\n      const roiPct = getPlanRoiPct(inv.plan_id);\n      const gross = calculateWeeklyROI(inv.amount_usd, inv.plan_id);\n      const net = Number((gross * (1 - serviceFeePct / 100)).toFixed(2));\n\n      // Upsert USD wallet\n      const { data: wallet } = await supabaseServer\n        .from('wallets')\n        .select('id,amount')\n        .eq('user_id', inv.user_id)\n        .eq('currency', 'USD')\n        .maybeSingle();\n      if (wallet?.id) {\n        await supabaseServer\n          .from('wallets')\n          .update({ amount: Number(wallet.amount) + net })\n          .eq('id', wallet.id);\n      } else {\n        await supabaseServer\n          .from('wallets')\n          .insert({ user_id: inv.user_id, currency: 'USD', amount: net });\n      }\n\n      await supabaseServer\n        .from('transactions')\n        .insert({\n          user_id: inv.user_id,\n          type: 'roi',\n          amount_usd: net,\n          meta: { investment_id: inv.id, applied_weekly_roi: roiPct, service_fee_pct: serviceFeePct }\n        });\n\n      results.push({ investmentId: inv.id, action: 'roi_credited', net });\n    }\n\n    // Release principal at day 14 if not yet released\n    const { data: relTx } = await supabaseServer\n      .from('transactions')\n      .select('id')\n      .eq('user_id', inv.user_id)\n      .eq('type', 'principal_release')\n      .contains('meta', { investment_id: inv.id })\n      .limit(1);\n\n    if (now >= maturityDate && (!relTx || relTx.length === 0)) {\n      // Credit principal to wallet\n      const { data: wallet2 } = await supabaseServer\n        .from('wallets')\n        .select('id,amount')\n        .eq('user_id', inv.user_id)\n        .eq('currency', 'USD')\n        .maybeSingle();\n      if (wallet2?.id) {\n        await supabaseServer\n          .from('wallets')\n          .update({ amount: Number(wallet2.amount) + Number(inv.amount_usd) })\n          .eq('id', wallet2.id);\n      } else {\n        await supabaseServer\n          .from('wallets')\n          .insert({ user_id: inv.user_id, currency: 'USD', amount: inv.amount_usd });\n      }\n\n      await supabaseServer\n        .from('transactions')\n        .insert({ user_id: inv.user_id, type: 'principal_release', amount_usd: inv.amount_usd, meta: { investment_id: inv.id } });\n\n      await supabaseServer\n        .from('investments')\n        .update({ status: 'completed' })\n        .eq('id', inv.id);\n\n      results.push({ investmentId: inv.id, action: 'principal_released', amount: inv.amount_usd });\n    }\n  }\n\n  return res.status(200).json({ ok: true, results });\n}\n"],"names":[],"mappings":"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","debugId":null}}]
}