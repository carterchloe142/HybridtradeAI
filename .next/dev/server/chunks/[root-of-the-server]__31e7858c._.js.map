{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 40, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/Documents/trae_projects/HYBRID%20TRADE%20AI/src/lib/prisma.ts"],"sourcesContent":["import { PrismaClient } from '@prisma/client'\n\ndeclare global {\n  // eslint-disable-next-line no-var\n  var prisma: PrismaClient | undefined\n}\n\nexport const prisma: PrismaClient = globalThis.prisma ?? new PrismaClient({ log: ['error'] })\n\nif (process.env.NODE_ENV !== 'production') globalThis.prisma = prisma\n\nexport default prisma\n"],"names":[],"mappings":";;;;;;AAAA;;AAOO,MAAM,SAAuB,WAAW,MAAM,IAAI,IAAI,6IAAY,CAAC;IAAE,KAAK;QAAC;KAAQ;AAAC;AAE3F,wCAA2C,WAAW,MAAM,GAAG;uCAEhD","debugId":null}},
    {"offset": {"line": 125, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/Documents/trae_projects/HYBRID%20TRADE%20AI/src/lib/requireRole.ts"],"sourcesContent":["import type { NextAuthOptions } from 'next-auth'\nimport { getServerSession } from 'next-auth'\nimport { NextResponse } from 'next/server'\n\nexport type Role = 'USER' | 'ADMIN'\n\nexport async function requireRole(\n  required: Role,\n  authOptions?: NextAuthOptions\n): Promise<{ user: any | null; error: 'unauthenticated' | 'forbidden' | null }> {\n  const session = authOptions ? await getServerSession(authOptions) : await (getServerSession as any)()\n  const user = session?.user as any\n  if (!user) return { user: null, error: 'unauthenticated' }\n  const role: Role = (user.role ?? 'USER')\n  if (required === 'ADMIN' && role !== 'ADMIN') return { user: null, error: 'forbidden' }\n  return { user, error: null }\n}\n\nexport async function requireRoleOrResponse(\n  required: Role,\n  authOptions?: NextAuthOptions\n): Promise<{ user: any } | NextResponse> {\n  const session = authOptions ? await getServerSession(authOptions) : await (getServerSession as any)()\n  const user = session?.user as any\n  if (!user) return NextResponse.json({ error: 'unauthenticated' }, { status: 401 })\n  const role: Role = (user.role ?? 'USER')\n  if (required === 'ADMIN' && role !== 'ADMIN') return NextResponse.json({ error: 'forbidden' }, { status: 403 })\n  return { user }\n}\n"],"names":[],"mappings":";;;;;;AACA;AACA;;;AAIO,eAAe,YACpB,QAAc,EACd,WAA6B;IAE7B,MAAM,UAAU,cAAc,MAAM,IAAA,2JAAgB,EAAC,eAAe,MAAM,AAAC,2JAAgB;IAC3F,MAAM,OAAO,SAAS;IACtB,IAAI,CAAC,MAAM,OAAO;QAAE,MAAM;QAAM,OAAO;IAAkB;IACzD,MAAM,OAAc,KAAK,IAAI,IAAI;IACjC,IAAI,aAAa,WAAW,SAAS,SAAS,OAAO;QAAE,MAAM;QAAM,OAAO;IAAY;IACtF,OAAO;QAAE;QAAM,OAAO;IAAK;AAC7B;AAEO,eAAe,sBACpB,QAAc,EACd,WAA6B;IAE7B,MAAM,UAAU,cAAc,MAAM,IAAA,2JAAgB,EAAC,eAAe,MAAM,AAAC,2JAAgB;IAC3F,MAAM,OAAO,SAAS;IACtB,IAAI,CAAC,MAAM,OAAO,gJAAY,CAAC,IAAI,CAAC;QAAE,OAAO;IAAkB,GAAG;QAAE,QAAQ;IAAI;IAChF,MAAM,OAAc,KAAK,IAAI,IAAI;IACjC,IAAI,aAAa,WAAW,SAAS,SAAS,OAAO,gJAAY,CAAC,IAAI,CAAC;QAAE,OAAO;IAAY,GAAG;QAAE,QAAQ;IAAI;IAC7G,OAAO;QAAE;IAAK;AAChB","debugId":null}},
    {"offset": {"line": 174, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/Documents/trae_projects/HYBRID%20TRADE%20AI/lib/supabaseServer.ts"],"sourcesContent":["import { createClient } from '@supabase/supabase-js'\n\nconst url = process.env.SUPABASE_URL || process.env.NEXT_PUBLIC_SUPABASE_URL || ''\nconst serviceKey = process.env.SUPABASE_SERVICE_ROLE_KEY || ''\n\nexport const supabaseServiceReady = Boolean(url && serviceKey)\n\nfunction createDisabledClient(): any {\n  const err = async () => { throw new Error('supabase_service_not_configured') }\n  const from = () => ({\n    select: err,\n    insert: err,\n    update: err,\n    delete: err,\n    eq: () => ({ select: err, insert: err, update: err, delete: err }),\n    order: () => ({ select: err }),\n    range: () => ({ select: err }),\n    maybeSingle: err,\n  })\n  return { auth: { getUser: err }, from }\n}\n\nexport const supabaseServer = supabaseServiceReady ? createClient(url, serviceKey) : createDisabledClient()\n"],"names":[],"mappings":";;;;;;AAAA;;AAEA,MAAM,MAAM,QAAQ,GAAG,CAAC,YAAY,oFAA4C;AAChF,MAAM,aAAa,QAAQ,GAAG,CAAC,yBAAyB,IAAI;AAErD,MAAM,uBAAuB,QAAQ,OAAO;AAEnD,SAAS;IACP,MAAM,MAAM;QAAc,MAAM,IAAI,MAAM;IAAmC;IAC7E,MAAM,OAAO,IAAM,CAAC;YAClB,QAAQ;YACR,QAAQ;YACR,QAAQ;YACR,QAAQ;YACR,IAAI,IAAM,CAAC;oBAAE,QAAQ;oBAAK,QAAQ;oBAAK,QAAQ;oBAAK,QAAQ;gBAAI,CAAC;YACjE,OAAO,IAAM,CAAC;oBAAE,QAAQ;gBAAI,CAAC;YAC7B,OAAO,IAAM,CAAC;oBAAE,QAAQ;gBAAI,CAAC;YAC7B,aAAa;QACf,CAAC;IACD,OAAO;QAAE,MAAM;YAAE,SAAS;QAAI;QAAG;IAAK;AACxC;AAEO,MAAM,iBAAiB,uBAAuB,IAAA,yMAAY,EAAC,KAAK,cAAc","debugId":null}},
    {"offset": {"line": 220, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/Documents/trae_projects/HYBRID%20TRADE%20AI/src/lib/supabaseServer.ts"],"sourcesContent":["export { supabaseServer, supabaseServiceReady } from '../../lib/supabaseServer'\n"],"names":[],"mappings":";AAAA","debugId":null}},
    {"offset": {"line": 281, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/Documents/trae_projects/HYBRID%20TRADE%20AI/src/lib/redis.ts"],"sourcesContent":["import Redis from 'ioredis'\n\nexport function createClient(url = process.env.REDIS_URL || 'redis://localhost:6379') {\n  const tlsOpts = url.startsWith('rediss://') ? { tls: { rejectUnauthorized: false } } : {}\n  const client = new Redis(url, tlsOpts as any)\n  client.on('error', () => {})\n  client.on('connect', () => {})\n  client.on('ready', () => {})\n  client.on('end', () => {})\n  return client\n}\n\nexport const redis = createClient()\n\nexport function duplicate(client: Redis) {\n  const dup = client.duplicate()\n  dup.on('error', () => {})\n  dup.on('connect', () => {})\n  dup.on('ready', () => {})\n  dup.on('end', () => {})\n  return dup\n}\n\nexport const pub = duplicate(redis)\nexport const sub = duplicate(redis)\n\nexport function createSubscriber(url = process.env.REDIS_URL || 'redis://localhost:6379') {\n  return duplicate(createClient(url))\n}\n"],"names":[],"mappings":";;;;;;;;;;;;;;AAAA;;AAEO,SAAS,aAAa,MAAM,QAAQ,GAAG,CAAC,SAAS,IAAI,wBAAwB;IAClF,MAAM,UAAU,IAAI,UAAU,CAAC,eAAe;QAAE,KAAK;YAAE,oBAAoB;QAAM;IAAE,IAAI,CAAC;IACxF,MAAM,SAAS,IAAI,sJAAK,CAAC,KAAK;IAC9B,OAAO,EAAE,CAAC,SAAS,KAAO;IAC1B,OAAO,EAAE,CAAC,WAAW,KAAO;IAC5B,OAAO,EAAE,CAAC,SAAS,KAAO;IAC1B,OAAO,EAAE,CAAC,OAAO,KAAO;IACxB,OAAO;AACT;AAEO,MAAM,QAAQ;AAEd,SAAS,UAAU,MAAa;IACrC,MAAM,MAAM,OAAO,SAAS;IAC5B,IAAI,EAAE,CAAC,SAAS,KAAO;IACvB,IAAI,EAAE,CAAC,WAAW,KAAO;IACzB,IAAI,EAAE,CAAC,SAAS,KAAO;IACvB,IAAI,EAAE,CAAC,OAAO,KAAO;IACrB,OAAO;AACT;AAEO,MAAM,MAAM,UAAU;AACtB,MAAM,MAAM,UAAU;AAEtB,SAAS,iBAAiB,MAAM,QAAQ,GAAG,CAAC,SAAS,IAAI,wBAAwB;IACtF,OAAO,UAAU,aAAa;AAChC","debugId":null}},
    {"offset": {"line": 328, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/Documents/trae_projects/HYBRID%20TRADE%20AI/src/lib/sse.ts"],"sourcesContent":["import type Redis from 'ioredis'\nimport { pub, sub } from './redis'\n\nexport async function publish(channel: string, payload: unknown) {\n  const data = JSON.stringify(payload)\n  await pub.publish(channel, data)\n}\n\nexport function subscribe(channel: string, handler: (payload: any) => void, client: Redis = sub) {\n  client.subscribe(channel)\n  const onMessage = (ch: string, message: string) => {\n    if (ch !== channel) return\n    try {\n      handler(JSON.parse(message))\n    } catch {\n      handler(message)\n    }\n  }\n  client.on('message', onMessage)\n  return () => {\n    client.off('message', onMessage)\n    client.unsubscribe(channel)\n  }\n}\n\nexport const HEARTBEAT_MS = 25000\n\nexport function encodeSSE(data: any, id?: string, event?: string) {\n  const payload = typeof data === 'string' ? data : JSON.stringify(data)\n  const idLine = id ? `id: ${id}\\n` : ''\n  const eventLine = event ? `event: ${event}\\n` : ''\n  return new TextEncoder().encode(`${idLine}${eventLine}data: ${payload}\\n\\n`)\n}\n"],"names":[],"mappings":";;;;;;;;;;AACA;;AAEO,eAAe,QAAQ,OAAe,EAAE,OAAgB;IAC7D,MAAM,OAAO,KAAK,SAAS,CAAC;IAC5B,MAAM,4HAAG,CAAC,OAAO,CAAC,SAAS;AAC7B;AAEO,SAAS,UAAU,OAAe,EAAE,OAA+B,EAAE,SAAgB,4HAAG;IAC7F,OAAO,SAAS,CAAC;IACjB,MAAM,YAAY,CAAC,IAAY;QAC7B,IAAI,OAAO,SAAS;QACpB,IAAI;YACF,QAAQ,KAAK,KAAK,CAAC;QACrB,EAAE,OAAM;YACN,QAAQ;QACV;IACF;IACA,OAAO,EAAE,CAAC,WAAW;IACrB,OAAO;QACL,OAAO,GAAG,CAAC,WAAW;QACtB,OAAO,WAAW,CAAC;IACrB;AACF;AAEO,MAAM,eAAe;AAErB,SAAS,UAAU,IAAS,EAAE,EAAW,EAAE,KAAc;IAC9D,MAAM,UAAU,OAAO,SAAS,WAAW,OAAO,KAAK,SAAS,CAAC;IACjE,MAAM,SAAS,KAAK,CAAC,IAAI,EAAE,GAAG,EAAE,CAAC,GAAG;IACpC,MAAM,YAAY,QAAQ,CAAC,OAAO,EAAE,MAAM,EAAE,CAAC,GAAG;IAChD,OAAO,IAAI,cAAc,MAAM,CAAC,GAAG,SAAS,UAAU,MAAM,EAAE,QAAQ,IAAI,CAAC;AAC7E","debugId":null}},
    {"offset": {"line": 371, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/Documents/trae_projects/HYBRID%20TRADE%20AI/app/api/user/notifications/stream/route.ts"],"sourcesContent":["import { NextRequest } from 'next/server'\nimport prisma from '@lib/prisma'\nimport { requireRole } from '@lib/requireRole'\nimport { supabaseServer } from '@lib/supabaseServer'\nimport { subscribe } from '@lib/sse'\n\nfunction sse(data: any, id?: string, event?: string) {\n  const payload = typeof data === 'string' ? data : JSON.stringify(data)\n  const idLine = id ? `id: ${id}\\n` : ''\n  const eventLine = event ? `event: ${event}\\n` : ''\n  return new TextEncoder().encode(`${idLine}${eventLine}data: ${payload}\\n\\n`)\n}\n\nexport async function GET(req: NextRequest) {\n  let userId = ''\n  const url = new URL(req.url)\n  const token = url.searchParams.get('token') || ''\n  if (token) {\n    const { data, error } = await supabaseServer.auth.getUser(token)\n    if (!error && data?.user?.id) userId = String(data.user.id)\n  }\n  if (!userId) {\n    const { user, error } = await requireRole('USER')\n    if (error) return new Response(JSON.stringify({ error }), { status: error === 'unauthenticated' ? 401 : 403 })\n    userId = String(user.id)\n  }\n  const lastEventId = url.searchParams.get('lastEventId')\n  const lastDate = lastEventId ? new Date(lastEventId) : null\n\n  const stream = new ReadableStream({\n    async start(controller) {\n      const heartbeat = setInterval(() => controller.enqueue(new TextEncoder().encode(`:hb\\n\\n`)), 25000)\n\n      if (lastDate && !isNaN(lastDate.getTime())) {\n        const personals = await prisma.notification.findMany({\n          where: { userId, createdAt: { gt: lastDate } },\n          orderBy: { createdAt: 'asc' },\n          take: 100,\n        })\n        for (const n of personals) controller.enqueue(sse(n, n.id, 'personal'))\n      }\n\n      const channel = `user:${userId}`\n      const unsubUser = subscribe(channel, (payload) => {\n        controller.enqueue(sse(payload, payload.id ?? undefined, 'personal'))\n      })\n      const unsubGlobal = subscribe('broadcast', (payload) => {\n        controller.enqueue(sse(payload, payload.id ?? undefined, 'global'))\n      })\n\n      controller.enqueue(new TextEncoder().encode(`:connected\\n\\n`))\n\n      ;(req as any).signal?.addEventListener?.('abort', () => {\n        clearInterval(heartbeat)\n        unsubUser()\n        unsubGlobal()\n        controller.close()\n      })\n    },\n    cancel() {},\n  })\n\n  return new Response(stream, {\n    headers: {\n      'Content-Type': 'text/event-stream',\n      'Cache-Control': 'no-cache, no-transform',\n      Connection: 'keep-alive',\n    },\n  })\n}\n"],"names":[],"mappings":";;;;AACA;AACA;AACA;AAAA;AACA;;;;;AAEA,SAAS,IAAI,IAAS,EAAE,EAAW,EAAE,KAAc;IACjD,MAAM,UAAU,OAAO,SAAS,WAAW,OAAO,KAAK,SAAS,CAAC;IACjE,MAAM,SAAS,KAAK,CAAC,IAAI,EAAE,GAAG,EAAE,CAAC,GAAG;IACpC,MAAM,YAAY,QAAQ,CAAC,OAAO,EAAE,MAAM,EAAE,CAAC,GAAG;IAChD,OAAO,IAAI,cAAc,MAAM,CAAC,GAAG,SAAS,UAAU,MAAM,EAAE,QAAQ,IAAI,CAAC;AAC7E;AAEO,eAAe,IAAI,GAAgB;IACxC,IAAI,SAAS;IACb,MAAM,MAAM,IAAI,IAAI,IAAI,GAAG;IAC3B,MAAM,QAAQ,IAAI,YAAY,CAAC,GAAG,CAAC,YAAY;IAC/C,IAAI,OAAO;QACT,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,yIAAc,CAAC,IAAI,CAAC,OAAO,CAAC;QAC1D,IAAI,CAAC,SAAS,MAAM,MAAM,IAAI,SAAS,OAAO,KAAK,IAAI,CAAC,EAAE;IAC5D;IACA,IAAI,CAAC,QAAQ;QACX,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,IAAA,0IAAW,EAAC;QAC1C,IAAI,OAAO,OAAO,IAAI,SAAS,KAAK,SAAS,CAAC;YAAE;QAAM,IAAI;YAAE,QAAQ,UAAU,oBAAoB,MAAM;QAAI;QAC5G,SAAS,OAAO,KAAK,EAAE;IACzB;IACA,MAAM,cAAc,IAAI,YAAY,CAAC,GAAG,CAAC;IACzC,MAAM,WAAW,cAAc,IAAI,KAAK,eAAe;IAEvD,MAAM,SAAS,IAAI,eAAe;QAChC,MAAM,OAAM,UAAU;YACpB,MAAM,YAAY,YAAY,IAAM,WAAW,OAAO,CAAC,IAAI,cAAc,MAAM,CAAC,CAAC,OAAO,CAAC,IAAI;YAE7F,IAAI,YAAY,CAAC,MAAM,SAAS,OAAO,KAAK;gBAC1C,MAAM,YAAY,MAAM,iIAAM,CAAC,YAAY,CAAC,QAAQ,CAAC;oBACnD,OAAO;wBAAE;wBAAQ,WAAW;4BAAE,IAAI;wBAAS;oBAAE;oBAC7C,SAAS;wBAAE,WAAW;oBAAM;oBAC5B,MAAM;gBACR;gBACA,KAAK,MAAM,KAAK,UAAW,WAAW,OAAO,CAAC,IAAI,GAAG,EAAE,EAAE,EAAE;YAC7D;YAEA,MAAM,UAAU,CAAC,KAAK,EAAE,QAAQ;YAChC,MAAM,YAAY,IAAA,gIAAS,EAAC,SAAS,CAAC;gBACpC,WAAW,OAAO,CAAC,IAAI,SAAS,QAAQ,EAAE,IAAI,WAAW;YAC3D;YACA,MAAM,cAAc,IAAA,gIAAS,EAAC,aAAa,CAAC;gBAC1C,WAAW,OAAO,CAAC,IAAI,SAAS,QAAQ,EAAE,IAAI,WAAW;YAC3D;YAEA,WAAW,OAAO,CAAC,IAAI,cAAc,MAAM,CAAC,CAAC,cAAc,CAAC;YAE1D,IAAY,MAAM,EAAE,mBAAmB,SAAS;gBAChD,cAAc;gBACd;gBACA;gBACA,WAAW,KAAK;YAClB;QACF;QACA,WAAU;IACZ;IAEA,OAAO,IAAI,SAAS,QAAQ;QAC1B,SAAS;YACP,gBAAgB;YAChB,iBAAiB;YACjB,YAAY;QACd;IACF;AACF","debugId":null}}]
}