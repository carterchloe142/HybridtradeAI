{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 10, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/Documents/trae_projects/HYBRID%20TRADE%20AI/lib/rateLimit.ts"],"sourcesContent":["import type { NextApiRequest, NextApiResponse } from 'next';\n\ntype LimiterOptions = { windowMs: number; max: number };\ntype Hit = { count: number; resetAt: number };\n\nconst store = new Map<string, Hit>();\n\nfunction getIp(req: NextApiRequest) {\n  const xfwd = (req.headers['x-forwarded-for'] || '') as string;\n  const ip = xfwd.split(',')[0].trim();\n  return ip || (req.socket as any)?.remoteAddress || 'unknown';\n}\n\nexport function createRateLimiter(opts: LimiterOptions) {\n  return async function check(req: NextApiRequest, res: NextApiResponse, key: string) {\n    const ip = getIp(req);\n    const id = `${ip}:${key}`;\n    const now = Date.now();\n    const hit = store.get(id);\n    if (!hit || now > hit.resetAt) {\n      store.set(id, { count: 1, resetAt: now + opts.windowMs });\n      res.setHeader('X-RateLimit-Remaining', String(opts.max - 1));\n      return true;\n    }\n    if (hit.count >= opts.max) {\n      const retryMs = hit.resetAt - now;\n      res.setHeader('Retry-After', String(Math.ceil(retryMs / 1000)));\n      res.status(429).json({ error: 'Too many requests' });\n      return false;\n    }\n    hit.count += 1;\n    store.set(id, hit);\n    res.setHeader('X-RateLimit-Remaining', String(opts.max - hit.count));\n    return true;\n  };\n}\n"],"names":[],"mappings":";;;;AAKA,MAAM,QAAQ,IAAI;AAElB,SAAS,MAAM,GAAmB;IAChC,MAAM,OAAQ,IAAI,OAAO,CAAC,kBAAkB,IAAI;IAChD,MAAM,KAAK,KAAK,KAAK,CAAC,IAAI,CAAC,EAAE,CAAC,IAAI;IAClC,OAAO,MAAO,IAAI,MAAM,EAAU,iBAAiB;AACrD;AAEO,SAAS,kBAAkB,IAAoB;IACpD,OAAO,eAAe,MAAM,GAAmB,EAAE,GAAoB,EAAE,GAAW;QAChF,MAAM,KAAK,MAAM;QACjB,MAAM,KAAK,GAAG,GAAG,CAAC,EAAE,KAAK;QACzB,MAAM,MAAM,KAAK,GAAG;QACpB,MAAM,MAAM,MAAM,GAAG,CAAC;QACtB,IAAI,CAAC,OAAO,MAAM,IAAI,OAAO,EAAE;YAC7B,MAAM,GAAG,CAAC,IAAI;gBAAE,OAAO;gBAAG,SAAS,MAAM,KAAK,QAAQ;YAAC;YACvD,IAAI,SAAS,CAAC,yBAAyB,OAAO,KAAK,GAAG,GAAG;YACzD,OAAO;QACT;QACA,IAAI,IAAI,KAAK,IAAI,KAAK,GAAG,EAAE;YACzB,MAAM,UAAU,IAAI,OAAO,GAAG;YAC9B,IAAI,SAAS,CAAC,eAAe,OAAO,KAAK,IAAI,CAAC,UAAU;YACxD,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAAoB;YAClD,OAAO;QACT;QACA,IAAI,KAAK,IAAI;QACb,MAAM,GAAG,CAAC,IAAI;QACd,IAAI,SAAS,CAAC,yBAAyB,OAAO,KAAK,GAAG,GAAG,IAAI,KAAK;QAClE,OAAO;IACT;AACF","debugId":null}},
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/Documents/trae_projects/HYBRID%20TRADE%20AI/lib/supabaseServer.ts"],"sourcesContent":["import { createClient } from '@supabase/supabase-js'\n\nconst url = process.env.SUPABASE_URL || process.env.NEXT_PUBLIC_SUPABASE_URL || ''\nconst serviceKey = process.env.SUPABASE_SERVICE_ROLE_KEY || ''\n\nexport const supabaseServiceReady = Boolean(url && serviceKey)\n\nfunction createDisabledClient(): any {\n  const err = async () => { throw new Error('supabase_service_not_configured') }\n  const from = () => ({\n    select: err,\n    insert: err,\n    update: err,\n    delete: err,\n    eq: () => ({ select: err, insert: err, update: err, delete: err }),\n    order: () => ({ select: err }),\n    range: () => ({ select: err }),\n    maybeSingle: err,\n  })\n  return { auth: { getUser: err }, from }\n}\n\nexport const supabaseServer = supabaseServiceReady ? createClient(url, serviceKey) : createDisabledClient()\n"],"names":[],"mappings":";;;;;;AAAA;;AAEA,MAAM,MAAM,QAAQ,GAAG,CAAC,YAAY,oFAA4C;AAChF,MAAM,aAAa,QAAQ,GAAG,CAAC,yBAAyB,IAAI;AAErD,MAAM,uBAAuB,QAAQ,OAAO;AAEnD,SAAS;IACP,MAAM,MAAM;QAAc,MAAM,IAAI,MAAM;IAAmC;IAC7E,MAAM,OAAO,IAAM,CAAC;YAClB,QAAQ;YACR,QAAQ;YACR,QAAQ;YACR,QAAQ;YACR,IAAI,IAAM,CAAC;oBAAE,QAAQ;oBAAK,QAAQ;oBAAK,QAAQ;oBAAK,QAAQ;gBAAI,CAAC;YACjE,OAAO,IAAM,CAAC;oBAAE,QAAQ;gBAAI,CAAC;YAC7B,OAAO,IAAM,CAAC;oBAAE,QAAQ;gBAAI,CAAC;YAC7B,aAAa;QACf,CAAC;IACD,OAAO;QAAE,MAAM;YAAE,SAAS;QAAI;QAAG;IAAK;AACxC;AAEO,MAAM,iBAAiB,uBAAuB,IAAA,iKAAY,EAAC,KAAK,cAAc","debugId":null}},
    {"offset": {"line": 104, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/Documents/trae_projects/HYBRID%20TRADE%20AI/lib/adminAuth.ts"],"sourcesContent":["import type { NextApiRequest } from 'next';\nimport { supabaseServer } from './supabaseServer';\n\nexport type AdminCheck = { ok: boolean; userId?: string; error?: string };\n\nexport async function requireAdmin(req: NextApiRequest): Promise<AdminCheck> {\n  try {\n    const auth = String(req.headers.authorization || '');\n    const token = auth.startsWith('Bearer ') ? auth.slice(7) : '';\n    if (!token) return { ok: false, error: 'Missing Authorization bearer token' };\n\n    const { data: userData, error: userErr } = await supabaseServer.auth.getUser(token);\n    if (userErr || !userData?.user?.id) return { ok: false, error: 'Invalid token' };\n    const userId = userData.user.id;\n\n    const { data: profile, error } = await supabaseServer\n      .from('profiles')\n      .select('role,is_admin')\n      .eq('user_id', userId)\n      .maybeSingle();\n    if (error) return { ok: false, error: 'Profile lookup failed' };\n    const role = String(profile?.role || '').toLowerCase();\n    const isAdmin = Boolean(profile?.is_admin) || role === 'admin';\n    if (!isAdmin) return { ok: false, error: 'Forbidden' };\n    return { ok: true, userId };\n  } catch (e: any) {\n    return { ok: false, error: e?.message || 'Admin check failed' };\n  }\n}\n\n"],"names":[],"mappings":";;;;AACA;;AAIO,eAAe,aAAa,GAAmB;IACpD,IAAI;QACF,MAAM,OAAO,OAAO,IAAI,OAAO,CAAC,aAAa,IAAI;QACjD,MAAM,QAAQ,KAAK,UAAU,CAAC,aAAa,KAAK,KAAK,CAAC,KAAK;QAC3D,IAAI,CAAC,OAAO,OAAO;YAAE,IAAI;YAAO,OAAO;QAAqC;QAE5E,MAAM,EAAE,MAAM,QAAQ,EAAE,OAAO,OAAO,EAAE,GAAG,MAAM,gIAAc,CAAC,IAAI,CAAC,OAAO,CAAC;QAC7E,IAAI,WAAW,CAAC,UAAU,MAAM,IAAI,OAAO;YAAE,IAAI;YAAO,OAAO;QAAgB;QAC/E,MAAM,SAAS,SAAS,IAAI,CAAC,EAAE;QAE/B,MAAM,EAAE,MAAM,OAAO,EAAE,KAAK,EAAE,GAAG,MAAM,gIAAc,CAClD,IAAI,CAAC,YACL,MAAM,CAAC,iBACP,EAAE,CAAC,WAAW,QACd,WAAW;QACd,IAAI,OAAO,OAAO;YAAE,IAAI;YAAO,OAAO;QAAwB;QAC9D,MAAM,OAAO,OAAO,SAAS,QAAQ,IAAI,WAAW;QACpD,MAAM,UAAU,QAAQ,SAAS,aAAa,SAAS;QACvD,IAAI,CAAC,SAAS,OAAO;YAAE,IAAI;YAAO,OAAO;QAAY;QACrD,OAAO;YAAE,IAAI;YAAM;QAAO;IAC5B,EAAE,OAAO,GAAQ;QACf,OAAO;YAAE,IAAI;YAAO,OAAO,GAAG,WAAW;QAAqB;IAChE;AACF","debugId":null}},
    {"offset": {"line": 150, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/Documents/trae_projects/HYBRID%20TRADE%20AI/pages/api/admin/kyc.ts"],"sourcesContent":["import type { NextApiRequest, NextApiResponse } from 'next'\nimport { createRateLimiter } from '../../../lib/rateLimit'\nimport { requireAdmin } from '../../../lib/adminAuth'\nimport { supabaseServer } from '../../../lib/supabaseServer'\n\nconst limiter = createRateLimiter({ windowMs: 60_000, max: 20 })\n\nexport default async function handler(req: NextApiRequest, res: NextApiResponse) {\n  const admin = await requireAdmin(req)\n  if (!admin.ok) return res.status(401).json({ error: admin.error || 'unauthorized' })\n\n  if (req.method === 'GET') {\n    const userId = String((req.query as any)?.userId || '')\n    const files = String((req.query as any)?.files || '') === '1'\n    if (files && userId) {\n      try {\n        const bucket = (supabaseServer.storage as any).from('kyc')\n        const listRes = await bucket.list(userId, { limit: 20 })\n        const entries = Array.isArray(listRes.data) ? listRes.data : []\n        const nameStartsWith = (p: string) => entries.find((e: any) => String(e.name).startsWith(p))\n        const idEntry = nameStartsWith('id')\n        const selfieNeutral = nameStartsWith('selfie_neutral')\n        const selfieSmile = nameStartsWith('selfie_smile')\n        const selfieLeft = nameStartsWith('selfie_left')\n        const selfieRight = nameStartsWith('selfie_right')\n        const dataEntry = entries.find((e: any) => String(e.name) === 'data.json')\n        async function signed(path?: string) {\n          if (!path) return undefined\n          const s = await bucket.createSignedUrl(`${userId}/${path}`, 3600)\n          return s.data?.signedUrl as string | undefined\n        }\n        const idUrl = idEntry ? (await signed(idEntry.name)) : undefined\n        const neutralUrl = await signed(selfieNeutral?.name)\n        const smileUrl = await signed(selfieSmile?.name)\n        const leftUrl = await signed(selfieLeft?.name)\n        const rightUrl = await signed(selfieRight?.name)\n        let details: any = null\n        if (dataEntry) {\n          const { data: download } = await bucket.download(`${userId}/data.json`)\n          if (download) {\n            const txt = await download.text()\n            try { details = JSON.parse(txt) } catch { details = { raw: txt } }\n          }\n        }\n        return res.json({ ok: true, files: { idUrl, neutralUrl, smileUrl, leftUrl, rightUrl }, details })\n      } catch (e: any) {\n        return res.status(500).json({ error: e?.message || 'files_failed' })\n      }\n    }\n    // Fetch without email first to avoid schema differences\n    const base = await supabaseServer\n      .from('profiles')\n      .select('*')\n    if (base.error) return res.status(500).json({ error: base.error.message || 'list_failed' })\n    const items = (base.data as any[]) || []\n    // Enrich with email via Admin API\n    try {\n      const adminRes: any = await (supabaseServer as any).auth?.admin?.listUsers?.({ page: 1, perPage: 1000 })\n      const users = adminRes?.data?.users || adminRes?.users || []\n      const map = new Map<string, string>()\n      for (const u of users) {\n        const id = String(u?.id || '')\n        const email = String(u?.email || '')\n        if (id && email) map.set(id, email)\n      }\n      for (const it of items) {\n        const email = map.get(String(it.user_id)) || null\n        ;(it as any).email = email\n      }\n    } catch {}\n    return res.json({ ok: true, items })\n  }\n\n  if (req.method !== 'PATCH') return res.status(405).json({ error: 'method_not_allowed' })\n  if (!(await limiter(req, res, 'admin-kyc'))) return\n\n  const userId = String((req.body as any)?.userId || '')\n  const status = String((req.body as any)?.status || '').toLowerCase()\n  const levelRaw = (req.body as any)?.level\n  const level = typeof levelRaw === 'number' ? levelRaw : undefined\n  if (!userId || !['approved','rejected','pending'].includes(status)) return res.status(400).json({ error: 'invalid_payload' })\n\n  const now = new Date().toISOString()\n  const minimal: any = { kyc_status: status }\n  const optional: any = { kyc_decision_at: now }\n  if (status === 'rejected') optional.kyc_reject_reason = String((req.body as any)?.reason || '')\n  if (typeof level === 'number') optional.kyc_level = level\n\n  // First: minimal update by user_id\n  let u = await supabaseServer\n    .from('profiles')\n    .update(minimal)\n    .eq('user_id', userId)\n    .select('user_id')\n    .maybeSingle()\n  if (!u.error && u.data) {\n    // best-effort optional fields\n    await supabaseServer.from('profiles').update(optional).eq('user_id', userId)\n    return res.json({ ok: true })\n  }\n  // No 'id' column in this schema; skip id-based update\n\n  // If still failing, attempt full object by user_id, then by id\n  const full: any = { ...minimal, ...optional }\n  let f = await supabaseServer\n    .from('profiles')\n    .update(full)\n    .eq('user_id', userId)\n    .select('user_id')\n    .maybeSingle()\n  if (!f.error && f.data) return res.json({ ok: true })\n\n  const errMsg = u.error?.message || f.error?.message || 'update_failed'\n  return res.status(500).json({ error: errMsg })\n}\n\nexport const config = { api: { bodyParser: true } }\n"],"names":[],"mappings":"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","debugId":null}}]
}